<!DOCTYPE html>
<html lang="en-CA">

<head>
<meta charset="utf-8" />
<meta name="author" content="Trevor Wilson" />
<meta name="description" content="a place for me to bust out a blog on programming, infosec, emacs and things that interest me." />
<meta name="keywords" content="[programming coding infosec cybersecurity webextensions blog blogger bust docker linux emacs free software]" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.55.0-DEV" />

<link rel="canonical" href="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/">
<meta property="og:title" content="Install And Configure PostmarketOS With Plasma Mobile On The PinePhone" />
<meta property="og:description" content="Table of Contents  Introduction What not to post online Setting up the build environment  Ensure ~/.local/bin exists Install or clone pmbootstrap Clone pmaports  Initialize the pmbootstrap configuration for the pinephone Identify the block special file name Deploy to the SD card A bit about LUKS  Determine if a partition is LUKS encrypted Determine the format of a LUKS encrypted partition A quick look at a LUKS header Test mounting our LUKS Encrypted Partition  NCurses Over Serial Boot into postmarketOS Resize the screen Set the timezone, date &amp; time What&rsquo;s in the default runlevel?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/" />
<meta property="article:published_time" content="2020-06-07T08:04:14&#43;00:00"/>
<meta property="article:modified_time" content="2020-08-21T12:21:00-06:00"/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Install And Configure PostmarketOS With Plasma Mobile On The PinePhone"/>
<meta name="twitter:description" content="Table of Contents  Introduction What not to post online Setting up the build environment  Ensure ~/.local/bin exists Install or clone pmbootstrap Clone pmaports  Initialize the pmbootstrap configuration for the pinephone Identify the block special file name Deploy to the SD card A bit about LUKS  Determine if a partition is LUKS encrypted Determine the format of a LUKS encrypted partition A quick look at a LUKS header Test mounting our LUKS Encrypted Partition  NCurses Over Serial Boot into postmarketOS Resize the screen Set the timezone, date &amp; time What&rsquo;s in the default runlevel?"/>



<meta itemprop="name" content="Install And Configure PostmarketOS With Plasma Mobile On The PinePhone">
<meta itemprop="description" content="Table of Contents  Introduction What not to post online Setting up the build environment  Ensure ~/.local/bin exists Install or clone pmbootstrap Clone pmaports  Initialize the pmbootstrap configuration for the pinephone Identify the block special file name Deploy to the SD card A bit about LUKS  Determine if a partition is LUKS encrypted Determine the format of a LUKS encrypted partition A quick look at a LUKS header Test mounting our LUKS Encrypted Partition  NCurses Over Serial Boot into postmarketOS Resize the screen Set the timezone, date &amp; time What&rsquo;s in the default runlevel?">


<meta itemprop="datePublished" content="2020-06-07T08:04:14&#43;00:00" />
<meta itemprop="dateModified" content="2020-08-21T12:21:00-06:00" />
<meta itemprop="wordCount" content="19708">



<meta itemprop="keywords" content="pinephone,postmarketOS,plasma_mobile," />


<link rel="stylesheet" href="https://bloggerbust.ca/css/layout.css" />
<style type="text/css">
body {
  background-color: #26282A;
  color: #dbdbdb;
}

a { color: #dbdbdb; }

pre {
  background: #1D1F21;
  border: 1px solid #dbdbdb;
  border-radius: 5px;
}

code {
  background: #1D1F21;
}

blockquote {
  background: #1D1F21;
  border-left: 3px solid #dbdbdb;
}

table {
  margin: 1em auto;
  border-collapse: collapse;
}

table, th, td {
  border: 1px solid #dbdbdb;
}

th {
  background: #dbdbdb;
  color: #26282A;
}

.siteTitle a { color: #99cc66; }

.post .content h1{ color: #99cc66; }
.post .content h2{ color: #99cc66; }
.post .content h3{ color: #99cc66; }
.post .content h4{ color: #99cc66; }
.post .content h5{ color: #99cc66; }
.post .content h6{ color: #99cc66; }
.post .content a:hover { color: #99cc66; }
.social-link:hover { color: #99cc66; }
.nav-item-title:hover { color: #99cc66; }
.tag a:hover { color: #99cc66; }
.copyright { color: #404040 }
.poweredby { color: #404040 }
.poweredby a { color: #404040; }
.post-preview .title a{ color: #99cc66; }
.content-item a:hover{
  text-decoration: underline;
  color: #99cc66;
}
.post-list .title { color: #99cc66; }
.rmore { color: #99cc66; }
.terms .term a:hover {
  text-decoration: underline;
  color: #99cc66;
}

</style>

<link rel="stylesheet" href="https://bloggerbust.ca/css/site.css">



<title>


     Install And Configure PostmarketOS With Plasma Mobile On The PinePhone 

</title>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://bloggerbust.ca/">Blogger Bust</a>
    </div> 

    
    
    <a class="nav-item" href="https://bloggerbust.ca/about/"><div class="nav-item-title">About</div></a>
    
    <a class="nav-item" href="https://bloggerbust.ca/series"><div class="nav-item-title">Series</div></a>
    
    <a class="nav-item" href="https://bloggerbust.ca/page/"><div class="nav-item-title">Pages</div></a>
    
    <a class="nav-item active" href="https://bloggerbust.ca/post/"><div class="nav-item-title">Posts</div></a>
    

  </nav>
</div>

  
<div class="social-links-header">

  
  <a href="mailto:trevor.wilson@bloggerbust.ca"><div class="social-link">email</div></a>
  

  
  <a href="https://github.com/bloggerbust" target="_blank"><div class="social-link">gh</div></a>
  

  

  

  

</div>


</header>


<article class="post">
    <h1 class="title"> Install And Configure PostmarketOS With Plasma Mobile On The PinePhone </h1>
    <div class="content"> 

<div class="ox-hugo-toc toc">
<div></div>

<div class="heading">Table of Contents</div>

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#what-not-to-post-online">What not to post online</a></li>
<li><a href="#setting-up-the-build-environment">Setting up the build environment</a>

<ul>
<li><a href="#ensure-dot-local-bin-exists">Ensure <code>~/.local/bin</code> exists</a></li>
<li><a href="#install-or-clone-pmbootstrap">Install or clone pmbootstrap</a></li>
<li><a href="#clone-pmaports">Clone pmaports</a></li>
</ul></li>
<li><a href="#initialize-the-pmbootstrap-configuration-for-the-pinephone">Initialize the pmbootstrap configuration for the pinephone</a></li>
<li><a href="#identify-the-block-special-file-name">Identify the block special file name</a></li>
<li><a href="#deploy-to-the-sd-card">Deploy to the SD card</a></li>
<li><a href="#a-bit-about-luks">A bit about LUKS</a>

<ul>
<li><a href="#determine-if-a-partition-is-luks-encrypted">Determine if a partition is LUKS encrypted</a></li>
<li><a href="#determine-the-format-of-a-luks-encrypted-partition">Determine the format of a LUKS encrypted partition</a></li>
<li><a href="#a-quick-look-at-a-luks-header">A quick look at a LUKS header</a></li>
<li><a href="#test-mounting-our-luks-encrypted-partition">Test mounting our LUKS Encrypted Partition</a></li>
</ul></li>
<li><a href="#ncurses-over-serial">NCurses Over Serial</a></li>
<li><a href="#boot-into-postmarketos">Boot into postmarketOS</a></li>
<li><a href="#resize-the-screen">Resize the screen</a></li>
<li><a href="#set-the-timezone-date-and-time">Set the timezone, date &amp; time</a></li>
<li><a href="#what-s-in-the-default-runlevel">What&rsquo;s in the default runlevel?</a></li>
<li><a href="#improve-our-getty-configuration">Improve our getty configuration</a></li>
<li><a href="#configuring-wifi">Configuring Wifi</a></li>
<li><a href="#ntp-time-syncing">NTP time syncing</a></li>
<li><a href="#update-apk-index">Update APK Index</a></li>
<li><a href="#configure-logging">Configure Logging</a></li>
<li><a href="#upgrade-to-latest-repository">Upgrade to latest repository</a></li>
<li><a href="#configure-x-forwarding">Configure x-forwarding</a></li>
<li><a href="#set-a-theme">Set a theme</a></li>
<li><a href="#how-to-take-a-screen-shot">How to take a screen shot</a></li>
<li><a href="#audio-configuration">Audio configuration</a></li>
<li><a href="#dbus-basics">DBus Basics</a>

<ul>
<li><a href="#qt-dbus-viewer">Qt DBus Viewer</a></li>
<li><a href="#gnome-d-feet-d-bus-debugger">GNOME D-Feet D-Bus Debugger</a></li>
</ul></li>
<li><a href="#configure-the-modem">Configure the modem</a>

<ul>
<li><a href="#identify-the-serial-port">Identify the serial port</a></li>
<li><a href="#enable-ofono-debug-logging">Enable oFono debug logging</a></li>
<li><a href="#connect-to-the-modem">Connect to the modem</a></li>
<li><a href="#at-command-basics">AT Command Basics</a></li>
<li><a href="#send-an-at-command-from-the-shell">Send an AT command from the shell</a></li>
<li><a href="#configure-the-modem-for-audio">Configure the modem for audio</a></li>
<li><a href="#check-audio-mode">Check Audio Mode</a></li>
<li><a href="#check-audio-mute">Check Audio Mute</a></li>
<li><a href="#enable-full-functionality">Enable Full Functionality</a></li>
<li><a href="#enable--u--sim-card-detection">Enable (U)SIM card detection</a></li>
<li><a href="#power-saving">Power Saving</a></li>
<li><a href="#get-the-sim-s-imsi">Get the SIM&rsquo;s IMSI</a></li>
<li><a href="#power-cycle-the-modem">Power-cycle the modem</a></li>
</ul></li>
<li><a href="#gprs-and-lte-configuration">GPRS &amp; LTE configuration</a>

<ul>
<li><a href="#determine-your-operator-service-name">Determine your operator service name</a></li>
<li><a href="#determine-what-technology-standards-your-operator-supports">Determine what technology standards your operator supports</a></li>
<li><a href="#shutdown-ofono-service">Shutdown Ofono service</a></li>
<li><a href="#configure-apn-settings--mvno">Configure APN settings (MVNO)</a></li>
<li><a href="#ensure-a-context-is-active">Ensure a context is Active</a></li>
<li><a href="#static-ip-allocation">Static IP allocation</a></li>
</ul></li>
<li><a href="#send-and-receive-sms">Send and receive SMS</a></li>
<li><a href="#make-phone-calls">Make phone calls</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<p></div>
<!--endtoc--></p>

<h2 id="introduction">Introduction</h2>

<p>In this post I will install PostmarketOS + Plasma Mobile on the PinePhone. At the time of this writing many Plasma Mobile features are either not fully integrated or not working at all. I will be focusing on the configuring postmarketOS so that by the end of this post you should be able to make phone calls and both send and receive SMS. I will also delve into extra detail on subjects that I find interesting or that I think might be helpful for you to know when trouble shooting issues.</p>

<p>You might notice that sometimes I add <code>env TEMP=/dev/tmp</code> to the beginning of some commands. That is because my <code>temp</code> directory is not executable. You most likely will not need to do the same.</p>

<h2 id="what-not-to-post-online">What not to post online</h2>

<p>It is common for people to innocently reveal information that they shouldn&rsquo;t when seeking help online. After all, the very fact that they are asking for help indicates that they lack some level of knowledge, which is fine, we all need to begin our journey of learning somehow and asking questions is a great starting point. Sometimes people reveal information that can cause them serious trouble.</p>

<p><strong>Always</strong> redact the following details from command line output, configuration files, logs, screen shots, and written text that you share with others when seeking help or for any other reason. <strong>Never post a log or config file without sanitizing it!!</strong> In the words of Gandalf the Grey - Keep it secret, keep it safe!</p>

<dl>
<dt>IMSI</dt>
<dd>It is imperative that you never reveal your SIM card&rsquo;s <a href="https://en.wikipedia.org/wiki/International%5Fmobile%5Fsubscriber%5Fidentity">International Mobile Subscriber Identity</a> to anyone.</dd>
<dt>Private Cryptographic Keys</dt>
<dd>Never reveal private keys of any kind. I have seen people accidentally send their private SSH keys to paste sites such as <a href="https://termbin.com">https://termbin.com</a>. In the case of SSH, public keys have the file extension <code>pub</code> and the private ones have the same name without any file extension.</dd>
</dl>

<p>It is a very good idea to not share the following information with anyone that you do not fully trust:</p>

<dl>
<dt>IP Address</dt>
<dd>In particular your devices external IP Addresses, but I also redact or conceal information about the topology of my home network.</dd>
<dt>LUKS Header</dt>
<dd>Do not post your LUKS header because it provides an attacker with one piece of the puzzle to decrypt an encrypted volume</dd>
</dl>

<p>Information you might want to keep private because they could be used to leak some information about you</p>

<dl>
<dt>ICCID</dt>
<dd>Integrated Circuit Card Identifier can be used to identify the country and possibly the mobile network that the card was manufactured for.</dd>
</dl>

<p>If you take photos of your SIM, you should know that many SIM cards have the <em>IMSI</em> printed on their casing. It is also easy to take photos of serial numbers uniquely identifying your hardware such as the PinePhone&rsquo;s modem. This section is by no means complete, I include it simply to raise awareness.</p>

<h2 id="setting-up-the-build-environment">Setting up the build environment</h2>

<h3 id="ensure-dot-local-bin-exists">Ensure <code>~/.local/bin</code> exists</h3>

<p>Check that you have a <code>~/.local/bin</code> directory. If it does not exist, then create it using <a href="https://www.freedesktop.org/software/systemd/man/file-hierarchy.html#Home%20Directory">file-hierarchy man(7)</a> as a guide. Below is the first level directory hierarchy of my <code>~/.local/</code> path, including group and owner permissions:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">tree --noreport -L <span style="color:#3677a9">1</span> -pudg ~/.local</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/home/dustfinger/.local
├── [drwxr-x--- dustfinger dustfinger]  bin
├── [drwx------ dustfinger dustfinger]  lib64
├── [drwx------ dustfinger dustfinger]  share
└── [drwx------ dustfinger dustfinger]  var</code></pre></div>
<p>If the following command returns a 0, then you will need to add <code>~/.local/bin</code> to your path at the user session level:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#24909d">echo</span> <span style="color:#40ffff">$PATH</span> | grep -ci <span style="color:#ed9d13">&#39;\.local/bin&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">1</code></pre></div>
<p>Exactly how you do this in a persistent way depends on the shell being used. In general, you will need to set <code>$PATH</code> in one of the following files: <code>~/.profile</code>, <code>~/.&lt;shell&gt;_profile</code>, <code>~/.&lt;shell&gt;_login</code>. For example, if you are using <em>Bash</em>, then you can simply add the following to the bottom of <code>~/.bash_profile</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">PATH=$PATH:~/.local/bin/</code></pre></div>
<p>After that, run <code>source ~/bash_profile</code> in each of your open shells. The next time you login, it will be sourced automatically.</p>

<h3 id="install-or-clone-pmbootstrap">Install or clone pmbootstrap</h3>

<p>You have two choices. You can install pmbootstrap using pip by following <a href="https://wiki.postmarketos.org/wiki/Installing%5Fpmbootstrap#Installing%5Fautomatically">these instructions</a>, or you can <a href="https://wiki.postmarketos.org/wiki/Installing%5Fpmbootstrap#Installing%5Fmanually">clone the pmbootstrap repository and link to the executable</a>. I chose to clone the repository and link to the executable. There are two reasons for this: it will make it easier for me to debug the code and contribute to the project if I choose to, and I find that having the source code on my local system makes it more convenient to use as a reference.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#24909d">cd</span> ~/dev
git clone https://gitlab.com/postmarketOS/pmbootstrap.git</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Cloning into &#39;pmbootstrap&#39;...
remote: Enumerating objects: 1461, done.
remote: Counting objects: 100% (1461/1461), done.
remote: Compressing objects: 100% (443/443), done.
remote: Total 18404 (delta 1132), reused 1248 (delta 1011), pack-reused 16943
Receiving objects: 100% (18404/18404), 6.90 MiB | 3.03 MiB/s, done.
Resolving deltas: 100% (11560/11560), done.</code></pre></div>
<p>Now add a link to the pmbootstrap script from your <code>~/.local/bin</code> directory.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ln -s <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$PWD</span><span style="color:#ed9d13">/pmbootstrap/pmbootstrap.py&#34;</span> ~/.local/bin/pmbootstrap
ls -lah ~/.local/bin/pmbootstrap</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">lrwxrwxrwx 1 dustfinger dustfinger 47 May 24 06:55 /home/dustfinger/.local/bin/pmbootstrap -&gt; /home/dustfinger/dev/pmbootstrap/pmbootstrap.py</code></pre></div>
<p>At the time of this article the commit for the master branch of pmbootstrap was:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#24909d">cd</span> ~/dev/pmbootstrap
git rev-parse HEAD
pmbootstrap --version</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">445410d08c56a1fd2093ce2c0dda55ba2ac805de
1.20.0</code></pre></div>
<p>Run <code>pmbootstrap --help</code> for CLI documentation.</p>

<h3 id="clone-pmaports">Clone pmaports</h3>

<p>Cloning <em>pmaports</em> is entirely optional. If you do not perform this step, then pmbootstrap will clone pmaports into its local git cache. I prefer to keep all source repositories in one place, i.e. <code>~/dev</code>. For that reason, and for the same reasons that I chose to clone pmbootstrap, I will now clone pmaports.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#24909d">cd</span> ~/dev
git clone https://gitlab.com/postmarketOS/pmaports.git</code></pre></div>
<p>At the time of this article the commit has for the master branch of pmaports was:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#24909d">cd</span> ~/dev/pmaports
git rev-parse HEAD</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">a17a93102614fb2dba48cac2383b3e4280544241</code></pre></div>
<h2 id="initialize-the-pmbootstrap-configuration-for-the-pinephone">Initialize the pmbootstrap configuration for the pinephone</h2>

<p>Invoking <code>pmbootstrap init</code> will perform the following steps:</p>

<ol>
<li>Perform sanity checks and take actions if necessary</li>
<li>Invoke initialize config subroutine</li>
<li>If <code>~/.config/pmbootstrap.cfg</code> exists

<ol>
<li>load the config</li>
<li>set default values</li>
<li>remove invalid or outdated settings</li>
</ol></li>
<li>If config did not exist, load defaults</li>
<li>Ask for work path

<ol>
<li>If path does not exist, create it</li>
<li>Create and set <code>/WORK_PATH/version</code></li>
<li>Create <code>/WORK_PATH/cache_git</code></li>
</ol></li>
<li>update config with work path setting and save <code>~/.config/pmbootstrap.cfg</code>.</li>
<li>Perform version migration if necessary</li>
<li>Clone pmaports

<ol>
<li>Get path to pmaports repository

<ol>
<li>If <code>--aports</code> optional parameter is provided, then create link <code>/WORK_PATH/cache_git/pmaports</code> targeting provided path</li>
<li>else use <code>/WORK_PATH/cache_git/pmaports</code></li>
</ol></li>
<li>If repository does not exist at path, then clone it</li>
</ol></li>
<li>Choose Release Channel</li>
<li>Ask for vendor</li>
<li>Ask for device code name</li>
<li>Ask if it is okay to install non-free firmware</li>
<li>Ask for username</li>
<li>Ask for UI</li>
<li>Ask for build options: Parallel jobs, ccache per arch.</li>
<li>Ask for extra packages to be installed to rootfs</li>
<li>Ask for timezone</li>
<li>Ask for hostname</li>
<li>Ask for SSH keys</li>
<li>Save configuration</li>
<li>Remove (zap) existing chroots. i.e. will remove /WORK_PATH/chroot_*</li>
</ol>

<p>The <code>pmbootstrap init</code> command runs interactively, storing inputs from the user in the pmbootstrap configuration file, i.e. <code>~/.config/pmbootstrap.cfg</code>. If the <code>pmbootstrap.cfg</code> already exists, then it will use the values contained within as defaults the next time you initialize pmbootstrap.</p>

<p>I will walk through each user interaction of the pmbootstrap init sub command. Do not run this command with <code>sudo</code> or you will end up with incorrect ownership and permissions applied to the resulting artifacts. The command will use <code>sudo</code> internally and prompt you for credentials when required. Only provide the <code>--aports</code> optional parameter if you <a href="#clone-pmaports">cloned pmaports</a> above.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">env <span style="color:#40ffff">TEMP</span>=~/dev/tmp/ pmbootstrap --aports=~/dev/pmaports init</code></pre></div>
<p>Steps <em>1-4</em> have been completed. We are now on step <em>5</em>. Hit <code>&lt;RET&gt;</code> keeping the default working directory.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:04:02] Location of the &#39;work&#39; path. Multiple chroots (native, device arch, device rootfs) will be created in there.
[11:04:02] Work path [/home/dustfinger/.local/var/pmbootstrap]:</code></pre></div>
<p>Steps <em>5-8</em> have been completed. The working path has been created and now contains a <code>version</code> file, a <code>log.txt</code> file and a directory named <code>cache_git</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">tree --noreport -pug ~/.local/var/</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/home/dustfinger/.local/var/
└── [drwx------ dustfinger dustfinger]  pmbootstrap
    ├── [drwx------ dustfinger dustfinger]  cache_git
    ├── [-rw-r--r-- dustfinger dustfinger]  log.txt
    └── [-rw-r--r-- dustfinger dustfinger]  version</code></pre></div>
<p>We are now on step <em>9</em>. You will be asked to choose a postmarketOS release channel. At the time of writing there are two options, <em>stable</em> and <em>edge</em>. Since stable is marked as a work in progress we will stick with the default channel which is edge.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:05:22] NOTE: pmaports path: /home/dustfinger/dev/pmaports
[11:05:22] Choose the postmarketOS release channel.
[11:05:22] Available (2):
[11:05:22] * edge: Rolling release channel
[11:05:22] * stable: Upcoming beta release (WIP, DO NOT USE!)
[11:05:22] Channel [edge]:</code></pre></div>
<p>On step <em>10</em> you will be asked to choose a vendor. Enter <em>pine64</em> and hit <code>&lt;RET&gt;</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:06:12] Choose your target device vendor (either an existing one, or a new one for porting).
[11:06:12] Available vendors (49): alcatel, amazon, asus, bq, chuwi, fairphone, finepower, fly, fujitsu, google, gp, hisense, htc, huawei, infocus, jolla, leeco, lenovo, lg, medion, meizu, motorola, nextbit, nobby, nokia, oneplus, oppo, ouya, pine64, planet, purism, qemu, raspberry, samsung, semc, sharp, sony, surftab, t2m, tablet, teclast, tokio, wiko, wileyfox, wingtech, xiaomi, yu, zte, zuk
[11:06:12] Vendor [qemu]: pine64</code></pre></div>
<p>Step <em>11</em>: You will be asked to enter a <em>device codename</em>; enter <em>pinephone</em> and hit <code>&lt;RET&gt;</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:07:18] Available codenames (6): a64lts, dontbeevil, pinebookpro, pinephone, pinetab, rockpro64
[11:07:18] Device codename: pinephone</code></pre></div>
<p>Step <em>12</em>, if you would like to be able to use <em>Wifi</em> and <em>Bluetooth</em>, then hit <code>&lt;RET&gt;</code> accepting the default choice to install the nonfree firmware.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:10:14] This device has proprietary components, which trade some of your freedom with making more peripherals work.
[11:10:14] We would like to offer full functionality without hurting your freedom, but this is currently not possible for your device.
[11:10:14] device-pine64-pinephone-nonfree-firmware: Wifi and Bluetooth firmware
[11:10:14] Enable this package? (y/n) [y]:</code></pre></div>
<p>Step <em>13</em>, enter a username that you would like created for your phone and hit <code>&lt;RET&gt;</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:12:32] Username [user]: dustfinger</code></pre></div>
<p>Step <em>14</em>, enter <em>plasma-mobile-extras</em> and hit <code>&lt;RET&gt;</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:13:18] Available user interfaces (12):
[11:13:18] * none: No graphical environment
[11:13:18] * gnome: (Wayland) Gnome Shell (not for armhf)
[11:13:18] * i3wm: (X11) Tiling WM (keyboard required)
[11:13:18] * kodi: (Wayland) 10-foot UI useful on TV&#39;s
[11:13:18] * mate: (X11) MATE Desktop Environment, fork of GNOME2 (stylus recommended)
[11:13:18] * phosh: (Wayland) Mobile UI developed for the Librem 5 (works only with numeric passwords!)
[11:13:18] * plasma-desktop: (X11/Wayland) KDE Desktop Environment (works well with tablets)
[11:13:18] * plasma-mobile: (Wayland) Mobile variant of KDE Plasma (slow without hardware acceleration, allows only numeric passwords!)
[11:13:18] * plasma-mobile-extras: Plasma Mobile with more apps pre-installed (video and music players, pdf reader, etc.)
[11:13:18] * shelli: Plain console with touchscreen gesture support
[11:13:18] * sway: (Wayland) Tiling WM, drop-in replacement for i3wm (DOES NOT RUN WITHOUT HW ACCELERATION!)
[11:13:18] * weston: (Wayland) Reference compositor (demo, not a phone interface)
[11:13:18] * xfce4: (X11) Lightweight GTK+2 desktop (stylus recommended)
[11:13:18] User interface [weston]: plasma-mobile-extras</code></pre></div>
<p>Step <em>15</em>, it is safe to choose the default by just hitting <code>&lt;RET&gt;</code>, but feel free to change this if you desire. The valid units for <em>ccache</em> are: <code>K|M|G|T|Ki|Mi|Gi|Ti</code>. I kept with the defaults.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:15:50] Build options: Parallel jobs: 9, ccache per arch: 5G
[11:15:50] Change them? (y/n) [n]:</code></pre></div>
<p>Step <em>16</em>, enter <em>ofonoctl,minicom</em> with no space after the comma and hit <code>&lt;RET&gt;</code>. <a href="https://git.sr.ht/~martijnbraam/ofonoctl">The ofonoctl command</a> is used to control <a href="https://01.org/ofono">the ofono daemon</a> and <a href="https://salsa.debian.org/minicom-team/minicom">minicom</a> is a serial communication program that we will use to send <em>AT commands</em> to initialize the modem.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:17:00] Additional packages that will be installed to rootfs. Specify them in a comma separated list (e.g.: vim,file) or &#34;none&#34;
[11:17:00] Extra packages [none]: ofonoctl,minicom</code></pre></div>
<p>Step <em>17</em>: pmbootstrap will attempt to detect the timezone from the host machine, but it might fail.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:31:07] WARNING: Unable to determine timezone configuration on host, using GMT.</code></pre></div>
<p>Pmbootstrap assumes that a symlink exists named either <code>/etc/zoneinfo/localtime</code> or <code>/etc/localtime</code> pointing to the timezone in <code>/usr/share/zoneinfo/</code>. Not all distributions have such a symlink. This is what the configuration looks like on my Gentoo host:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cat /etc/timezone
ls -lah /etc/localtime
file /etc/localtime</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Canada/Mountain
-rw-r--r-- 1 root root 2.3K Dec  6 05:55 /etc/localtime
/etc/localtime: timezone data, version 2, 5 gmt time flags, 5 std time flags, no leap seconds, 150 transition times, 5 abbreviation chars</code></pre></div>
<p>As you can see, Gentoo keeps the timezone in <code>/etc/timezone</code> and <code>/etc/localtime</code> is the actual timezone file rather than a symlink. If your timezone is not detected, then like me, you will have to set the timezone manually later.</p>

<p>Step <em>18</em>: You can customize the hostname of your phone if you wish, or hit <code>&lt;RET&gt;</code> to accept the default. I am going to call my phone <em>Second Chance</em> from the sci-fi Novel <a href="https://en.wikipedia.org/wiki/Commonwealth%5FSaga#Pandora's%5FStar">Pandora&rsquo;s Star</a> by Peter F. Hamilton.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:31:07] Device hostname (short form, e.g. &#39;foo&#39;) [pine64-pinephone]: second-chance</code></pre></div>
<p>Step <em>19</em>: You will now be asked if you wish to copy your SSH keys from your host machine to your PinePhone. If you choose <em>y</em> here, then all files matching the pattern <code>~/.ssh/id_*.pub/</code> will be copied to <code>$HOME/.ssh/</code>. Perhaps you have public keys that you do not want copied to your phone. My preference is to manually copy specific SSH keys to my PinePhone if, and when I have a need to. I just kept the default by hitting <code>&lt;RET&gt;</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:50:22] Would you like to copy your SSH public keys to the device? (y/n) [n]:</code></pre></div>
<p>Step <em>20</em>, pmbootstrap will save your inputs to <code>~/.config/pmbootstrap.cfg</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cat ~/.config/pmbootstrap.cfg</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[pmbootstrap]
aports = /home/dustfinger/dev/pmaports
ccache_size = 5G
is_default_channel = False
device = pine64-pinephone
extra_packages = ofonoctl,minicom
hostname = second-chance
jobs = 9
kernel = stable
keymap =
nonfree_firmware = True
nonfree_userland = False
ssh_keys = False
timezone = GMT
ui = plasma-mobile-extras
ui_extras = False
user = dustfinger
work = /home/dustfinger/.local/var/pmbootstrap</code></pre></div>
<p>Step <em>21</em>, a reminder to run <code>pmbootstrap status</code> regularly to keep things up to date.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[11:51:02] WARNING: The chroots and git repositories in the work dir do not get updated automatically.
[11:51:02] Run &#39;pmbootstrap status&#39; once a day before working with pmbootstrap to make sure that everything is up-to-date.
[11:51:02] Done!</code></pre></div>
<h2 id="identify-the-block-special-file-name">Identify the block special file name</h2>

<p>Insert your SD card into your computer. My computer does not have an SD card reader, so I use an SD card USB adapter. Once inserted, the <em>SCSI</em> (Pron. &ldquo;scuzzy&rdquo;, Small Computer System Interface) device, will be registered with the SD mass-storage driver and assigned a letter. Letter assignment is in alphabetic order, meaning that the first SCSI device registered will be given the block special file name <code>/dev/sda</code>, the second device registered will be named <code>/dev/sdb</code> and so on. Additional block special file names will be assigned in numeric order providing an interface to each partition of the disk, e.g <code>/dev/sdx1</code>, <code>/dev/sdx2</code> etc. A disk image includes the partition table; for this reason, when we want to write an image to a disk, we need only know the letter assignment of the block special file name, e.g <code>/dev/sdb</code>. However; if we want to mount a disk&rsquo;s partition with read or write access, then we need to know the block special file name including the partition number, e.g <code>/dev/sdb1</code>. To find the block special file names of your SD card, run dmesg.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">dmesg | tail</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[1578133.409947] usb-storage 1-2:1.0: USB Mass Storage device detected
[1578133.410221] scsi host4: usb-storage 1-2:1.0
[1578134.429208] scsi 4:0:0:0: Direct-Access     Generic  STORAGE DEVICE   1404 PQ: 0 ANSI: 6
[1578134.429571] sd 4:0:0:0: Attached scsi generic sg1 type 0
[1578134.676148] sd 4:0:0:0: [sdb] 124735488 512-byte logical blocks: (63.9 GB/59.5 GiB)
[1578134.677349] sd 4:0:0:0: [sdb] Write Protect is off
[1578134.677356] sd 4:0:0:0: [sdb] Mode Sense: 21 00 00 00
[1578134.678529] sd 4:0:0:0: [sdb] Write cache: disabled, read cache: enabled, doesn&#39;t support DPO or FUA
[1578134.692971]  sdb: sdb1 sdb2
[1578134.697055] sd 4:0:0:0: [sdb] Attached SCSI removable disk</code></pre></div>
<p>From the output above we can see that my SCSI device was the second such device registered on my system and was therefore assigned the letter <code>b</code>. So I will need to use <code>/dev/sdb</code> as the SD card device name when writing the postmarketOS image to disk. If the tail of <code>dmesg</code> displays information from events unrelated to inserting the SD card, then try increasing the number of lines of output shown via the <code>-n</code> optional parameter, e.g. <code>dmesg | tail -n 50</code>.</p>

<p>Referring to <code>/dev/sdb/</code> as the SD card is a misnomer because the device name refers to the Small Computer System Interface (SCSI) used to read and write to the SD card and not the card itself. In my case, the device refers to my SD card USB adapter. If I insert the SD card USB adapter without the SD card, then the device is still registered with the mass-storage driver, but without the numbered block special file names that interface with the disk&rsquo;s partitions.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">dmesg | tail</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[1578380.920621] usb 1-2: new high-speed USB device number 96 using xhci_hcd
[1578380.936431] usb 1-2: New USB device found, idVendor=05e3, idProduct=0751, bcdDevice=14.04
[1578380.936433] usb 1-2: New USB device strings: Mfr=3, Product=4, SerialNumber=0
[1578380.936434] usb 1-2: Product: USB Storage
[1578380.936435] usb 1-2: Manufacturer: USB Storage
[1578380.937969] usb-storage 1-2:1.0: USB Mass Storage device detected
[1578380.938165] scsi host4: usb-storage 1-2:1.0
[1578381.981465] scsi 4:0:0:0: Direct-Access     Generic  STORAGE DEVICE   1404 PQ: 0 ANSI: 6
[1578381.981862] sd 4:0:0:0: Attached scsi generic sg1 type 0
[1578382.197257] sd 4:0:0:0: [sdb] Attached SCSI removable disk</code></pre></div>
<p>I am telling you all this because the order that devices are registered in is not guaranteed. Perhaps one day you have another mass storage device attached to your computer and now the special file name that you were so used to referring to your SD card is in fact referring to the one and only drive containing you precious family photos. Every single time you deploy an image to any disk, be absolutely certain that you have the correct special file name for the particular disk that you intended to completely overwrite.</p>

<p>It is crucial that you write the image to the correct device. When I provide the device name <code>/dev/sdb</code> to the <code>pmbootstrap install</code> command, <strong>you must remember</strong> to replace the device name with the name to your device.</p>

<h2 id="deploy-to-the-sd-card">Deploy to the SD card</h2>

<p>Invoking <code>pmbootstrap install</code> will perform the following steps:</p>

<ol>
<li>PREPARE NATIVE CHROOT</li>
<li>CREATE DEVICE ROOTFS (&ldquo;pine64-pinephone&rdquo;)</li>
<li>PREPARE INSTALL BLOCKDEVICE</li>
<li>FILL INSTALL BLOCKDEVICE</li>
<li>FLASHING TO DEVICE</li>
</ol>

<p><strong>CAUTION:</strong> It is <strong>crucial</strong> that you pick the <strong><a href="#identify-the-block-special-file-name">correct device name</a></strong>, because all existing data on the device will be removed. If you are unsure, simply remove the SD card and see if the device you think is your SD card still has one or more numbered block special file names, e.g <code>ls /dev/sdb1/</code>. If the numbered device names are <strong>only present while your card is inserted</strong>, then you can be confident that you have the correct device name.</p>

<p>Now that we know the correct device name, we can install postmarketOS + Plasma Mobile onto the SD card. I am going to tell pmbootstrap to encrypt my disk by passing the optional flag <code>--fde</code> which stands for <em>full disk encryption</em>, although it actually only encrypts the root partition leaving the boot partition unencrypted.</p>

<p>Despite the fact that the <em>L</em> in <em>LUKS</em> (Linux Unified Key Setup) stands for Linux, LUKS is a platform-independent on-disk encryption open standard. LUKS was a proof of concept for <em><a href="https://clemens.endorphin.org/TKS1-draft.pdf">TKS1</a></em> (Template Key Setup 1), but by <a href="https://gitlab.com/cryptsetup/cryptsetup/wikis/LUKS-standard/on-disk-format.pdf">LUKS version 1.0</a> the specification switched to the <em><a href="https://clemens.endorphin.org/nmihde/nmihde-A4-ds.pdf">TKS2</a></em> variant, making it easier to implement a transparent hard disk encryption subsystem. The <a href="https://gitlab.com/cryptsetup/LUKS2-docs/blob/master/luks2%5Fdoc%5Fwip.pdf">LUKS 2.0 specification</a> is a work in progress, but as of <a href="https://gitlab.com/cryptsetup/cryptsetup/-/blob/master/docs/v2.1.0-ReleaseNotes">cryptsetup 2.1, LUKS2 has become the default format type</a>.</p>

<p>Before trusting your data to LUKS, you should read the <a href="https://gitlab.com/cryptsetup/cryptsetup/-/wikis/FrequentlyAskedQuestions">LUKS FAQ</a> which covers some risks of using encrypted storage, how to trouble shoot issues, backup and data recovery, and a select number of security aspects. For <em>cryptsetup</em> usage instructions refer to <a href="http://man7.org/linux/man-pages/man8/cryptsetup.8.html">CRYPTSETUP(8)</a>. As mentioned in the previous paragraph, even though LUKS2 is currently a work in progress, it is actually the default format as of cryptsetup v2.1. It is possible that your system has an older version of cryptsetup installed. It is important to know what version of the LUKS format your disk was encrypted with when reading the <a href="https://gitlab.com/cryptsetup/cryptsetup/-/wikis/FrequentlyAskedQuestions">LUKS FAQ</a>, which, at the time of this writing, is LUKS1 specific. If you do not wish to have the data on your disk encrypted, then simply remove the <code>--fde</code> optional parameter from the install command shown below. However; I recommend that you protect your privacy by encrypting your root partition as I have done.</p>

<p>Do not run <code>pmbootstrap install</code> with <code>sudo</code>, the command will make internal calls to <code>sudo</code> when necessary and you will be prompted to enter your credentials as required. If something goes wrong and you need to run the install command again, be sure to zap the chroot environments first with <code>pmbootstrap zap</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">env <span style="color:#40ffff">TEMP</span>=~/dev/tmp/ pmbootstrap install --fde --sdcard=/dev/sdb</code></pre></div>
<p>The install script will also prompt you to set a password for your user account. At the time of writing, the virtual keyboard that is presented to you when entering your login password on the PlasmaMobile is a number pad. That means you must enter a numeric pin for your user&rsquo;s password or you will not be able to unlock the PlasmaMobile desktop. I know that is not secure, hopefully an alpha numeric virtual keyboard will be available in the future.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[13:55:22] *** (1/5) PREPARE NATIVE CHROOT ***
Password:
[13:55:37] Update package index for x86_64 (4 file(s))
[13:55:40] Download http://dl-cdn.alpinelinux.org/alpine/edge/main/x86_64/apk-tools-static-2.10.5-r1.apk
[13:55:40] (native) install alpine-base
[13:55:45] (native) install cryptsetup util-linux e2fsprogs parted dosfstools
[13:55:47] *** (2/5) CREATE DEVICE ROOTFS (&#34;pine64-pinephone&#34;) ***
[13:55:47] Update package index for aarch64 (4 file(s))
[13:55:50] (native) install qemu-aarch64
[13:55:50] Register qemu binfmt (aarch64)
[13:55:51] (rootfs_pine64-pinephone) install alpine-base
[13:55:56] (rootfs_pine64-pinephone) install postmarketos-base device-pine64-pinephone device-pine64-pinephone-nonfree-firmware postmarketos-ui-plasma-mobile-extras ofonoctl minicom
Password:
[14:02:35] (rootfs_pine64-pinephone) write /etc/os-release
[14:02:35] (rootfs_pine64-pinephone) install
[14:02:39] (rootfs_pine64-pinephone) install
[14:02:42] (rootfs_pine64-pinephone) mkinitfs postmarketos-allwinner
[14:03:08]  *** SET LOGIN PASSWORD FOR: &#39;dustfinger&#39; ***
New password:
Retype new password:
passwd: password updated successfully</code></pre></div>
<p>If you have installed postmarketOS in the past, then you will be warned that the SD card contains an installation of postmarketOS. In that case, type <em>y</em> and <code>&lt;RET&gt;</code> to remove the previous installation.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[14:04:14] NOTE: No valid keymap specified for device
[14:04:16] *** (3/5) PREPARE INSTALL BLOCKDEVICE ***
[14:04:16] (native) mount /dev/install (host: /dev/sdb)
[14:04:16] WARNING: This device has a previous installation of pmOS. CONTINUE? (y/n) [n]: y</code></pre></div>
<p>Enter a strong password for full disk encryption. Unlike when you unlock the PinePhone&rsquo;s desktop, you will be provided a standard virtual keyboard for unlocking the encrypted <em>LUKS</em> container, so please do include upper and lower case letters as well as numbers and special symbols. You want this passphrase to be strong so that it cannot easily be cracked; however, it is recommended that you limit the character set of the passphrase to <a href="https://en.wikipedia.org/wiki/ASCII#Printable%5Fcharacters">the 95 printable characters from 7-bit ASCII</a>. The reason to limit the characters used in the passphrase is because 7-bit ASCII stays the same for all ASCII variants and UTF-8. In other words, If the system&rsquo;s character encoding changes, your passphrase will stay the same so long as you follow this recommendation.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[14:13:22] (native) partition /dev/install (boot: 84M, root: the rest)
[14:13:22] WARNING: Full disk encryption is enabled!
[14:13:22] Make sure that osk-sdl has been properly configured for your device
[14:13:22] or else you will be unable to unlock the rootfs on boot!
[14:13:22] If you started a device port, it is recommended you disable
[14:13:22] FDE by re-running the install command without &#39;--fde&#39; until
[14:13:22] you have properly configured osk-sdl. More information:
[14:13:22] &lt;https://postmarketos.org/osk-port&gt;
[14:13:22] (native) format /dev/installp2 (root, luks), mount to /dev/mapper/pm_crypt
[14:13:22]  *** TYPE IN THE FULL DISK ENCRYPTION PASSWORD (TWICE!) ***
Enter passphrase for /dev/installp2:
WARNING: Locking directory /run/cryptsetup is missing!
Enter passphrase for /dev/installp2:</code></pre></div>
<p>The warning about the missing <code>/run/cryptsetup</code> directory is apparently a <a href="https://lists.debian.org/debian-boot/2019/02/msg00100.html">known and benign issue</a>. The postmarketOS PinePhone wiki Installation section links to the same <a href="https://wiki.postmarketos.org/wiki/PINE64%5FPinePhone%5F(pine64-pinephone)#Installation">Debian mailing list email</a>, but I was not able to find anything <strong>specifically</strong> about this on the <a href="https://gitlab.com/cryptsetup/cryptsetup/-/issues?scope=all&amp;utf8=%E2%9C%93&amp;state=all&amp;search=%22%2Frun%2Fcryptsetup+is+missing%22">cryptsetup issues tracker</a>.</p>

<p>The root file system that pmbootstrap prepared in <code>~/.local/var/pmbootstrap/chroot_rootfs_pine64-pinephone/</code> will now be deployed to the SD card.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[14:14:32] (native) format /dev/mapper/pm_crypt
[14:15:26] (native) mount /dev/mapper/pm_crypt to /mnt/install
[14:15:26] (native) format /dev/installp1 (boot, ext2), mount to /mnt/install/boot
[14:15:26] *** (4/5) FILL INSTALL BLOCKDEVICE ***
[14:15:26] (native) copy rootfs_pine64-pinephone to /mnt/install/
[14:15:34] Embed firmware u-boot/pine64-pinephone/u-boot-sunxi-with-spl.bin in the SD card image at offset 8 with step size 1024
[14:16:28] *** (5/5) FLASHING TO DEVICE ***
[14:16:28] Run the following to flash your installation to the target device:
[14:16:28] * If the above steps do not work, you can also create symlinks to the generated files with &#39;pmbootstrap export&#39; and flash outside of pmbootstrap.
[14:16:28] NOTE: chroot is still active (use &#39;pmbootstrap shutdown&#39; as necessary)
[14:16:28] Done</code></pre></div>
<p>If you take a look in the working directory, you will notice that many new artifacts have been created.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ls -lah ~/.local/var/pmbootstrap</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">total 2.3M
drwx------ 15 dustfinger dustfinger   19 May 24 14:11 .
drwx------  3 dustfinger dustfinger    3 May 24 11:05 ..
-rwx------  1 dustfinger dustfinger 2.9M May 24 14:11 apk.static
drwxr-xr-x  2 root       root        599 May 24 14:13 cache_apk_aarch64
drwxr-xr-x  2 root       root         57 May 24 14:11 cache_apk_x86_64
drwxr-xr-x  2 root       root          2 May 24 13:55 cache_ccache_aarch64
drwxr-xr-x  2      12345      12345    2 May 24 13:55 cache_ccache_x86_64
drwxr-xr-x  2 root       root          2 May 24 13:55 cache_distfiles
drwx------  2 dustfinger dustfinger    2 May 24 11:05 cache_git
drwxr-xr-x  2 dustfinger dustfinger   11 May 24 13:55 cache_http
drwxr-xr-x  4 root       root          4 May 24 13:55 cache_rust
drwxr-xr-x 19 root       root         19 May 24 14:11 chroot_native
drwxr-xr-x 20 root       root         20 May 24 14:11 chroot_rootfs_pine64-pinephone
drwxr-xr-x  2      12345      12345    2 May 24 13:55 config_abuild
drwxr-xr-x  2 root       root         10 May 24 14:11 config_apk_keys
-rw-r--r--  1 dustfinger dustfinger 384K May 24 14:20 log.txt
drwxr-xr-x  3 root       root          3 May 24 13:55 packages
-rw-r--r--  1 dustfinger dustfinger    2 May 24 11:05 version
-rw-r--r--  1 dustfinger dustfinger  142 May 24 14:11 workdir.cfg</code></pre></div>
<p>You can use the pmbootstrap chroot command to enter either the <code>chroot_native</code> or <code>chroot_rootfs_pine64-pinephone</code> by passing the corresponding suffix via the optional <code>-s</code> parameter, e.g. <code>pmbootstrap chroot -s rootfs_pine64-pinephone</code>. Once you have finished looking around you should deactivate the chroot by running <code>pmbootstrap shutdown</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">pmbootstrap shutdown</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[14:20:51] Unregister qemu binfmt (aarch64)
[14:20:51] Done</code></pre></div>
<p>The deployment will have created two partitions on your SD card. Your device name might be different than mine, see <a href="#identify-the-block-special-file-name">Identify the block special file name</a></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/dev/sdb    # block special device name
/dev/sdb1   # unencrypted boot partition
/dev/sdb2   # luks encrypted parition containing the operating system and your personal data</code></pre></div>
<h2 id="a-bit-about-luks">A bit about LUKS</h2>

<h3 id="determine-if-a-partition-is-luks-encrypted">Determine if a partition is LUKS encrypted</h3>

<p>The <code>pmbootstrap install</code> command does not perform full raw disk encryption; although doing so is possible, it makes booting the device more complicated. Instead, the boot partition is left unencrypted and only the root partition is encrypted. If we try to mount the root partition directly the file-system will not be recognized.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo mount /dev/sdb2 /mnt/usb</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Password:
  mount: /mnt/usb: unknown filesystem type &#39;crypto_LUKS&#39;.</code></pre></div>
<p>You can test if a device has been LUKS encrypted using the <code>isLuks</code> subcommand. The subcommand succeeds if it is LUKS encrypted and fails otherwise. Normally, <code>isLuks</code>  is silent and simply returns success or failure, but by adding the <code>-v</code> optional flag we can make it verbose.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo cryptsetup isLuks -v /dev/sdb1</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Command failed with code -1 (wrong or missing parameters).</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo cryptsetup isLuks -v /dev/sdb2</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Command successful.</code></pre></div>
<h3 id="determine-the-format-of-a-luks-encrypted-partition">Determine the format of a LUKS encrypted partition</h3>

<p>The <code>isLuks</code> subcommand can also determine the format used in a LUKS encrypted partition via the <code>--type</code> optional parameter. The valid types are: plain, luks (default), luks1, luks2, loopaes or tcrypt.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo cryptsetup isLuks -v --type luks /dev/sdb2</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Command successful.</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo cryptsetup isLuks -v --type luks1 /dev/sdb2</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Command failed with code -1 (wrong or missing parameters).</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo cryptsetup isLuks -v --type luks2 /dev/sdb2</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Command successful.</code></pre></div>
<h3 id="a-quick-look-at-a-luks-header">A quick look at a LUKS header</h3>

<p>The LUKS format keeps metadata in the LUKS header. The LUKS header is what allows LUKS to provide features such as salting, iterated <a href="https://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> passphrase hashing and, key management. The two significant downside of the LUKS header are:</p>

<ol>
<li>The header is visible making it obvious that the disk is encrypted with LUKS</li>
<li>If the header is not backed up and becomes damaged, then the data on the disk is not recoverable unless you happen to still have the disk mounted.</li>
</ol>

<p>It is best not to post your header publicly because it provides an attacker with one piece of the puzzle to decrypt an encrypted volume even if the header has been stripped from the volume. Of course, an attacker would still need a passphrase for one of the key slots. The <code>luksDump</code> subcommand can be used to send the header to standard output. This is what a LUKS2 header looks like:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo cryptsetup luksDump /dev/sdb2</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">sudo cryptsetup luksDump /dev/sdb2
LUKS header information
Version:        2
Epoch:          3
Metadata area:  16384 [bytes]
Keyslots area:  16744448 [bytes]
UUID:           5c616a99-5054-40ac-958d-11e90e0b4c41
Label:          (no label)
Subsystem:      (no subsystem)
Flags:          (no flags)

Data segments:
  0: crypt
        offset: 16777216 [bytes]
        length: (whole device)
        cipher: aes-cbc-plain64
        sector: 512 [bytes]

Keyslots:
  0: luks2
        Key:        256 bits
        Priority:   normal
        Cipher:     aes-cbc-plain64
        Cipher key: 256 bits
        PBKDF:      argon2i
        Time cost:  4
        Memory:     149551
        Threads:    4
        Salt:       b5 a3 13 19 2a cf a9 15 23 a1 b3 df 13 46 2e 41
                    12 74 eb 32 74 b2 80 c3 46 01 26 92 ba 8f 3e da
        AF stripes: 4000
        AF hash:    sha256
        Area offset:32768 [bytes]
        Area length:131072 [bytes]
        Digest ID:  0
Tokens:
Digests:
  0: pbkdf2
        Hash:       sha256
        Iterations: 211406
        Salt:       4b 72 65 ef 41 da 3b 69 af 09 51 cd 37 40 fe b3
                    26 0a 12 53 cc 52 02 46 78 a3 54 21 79 0e 18 b4
        Digest:     66 83 25 b8 ca 9a 72 34 92 17 48 02 42 b7 8d 02
                    cf 3b 48 95 71 32 d5 f2 3c 86 25 67 3d fe 68 21</code></pre></div>
<p>See the <a href="https://gitlab.com/cryptsetup/LUKS2-docs/blob/master/luks2%5Fdoc%5Fwip.pdf">LUKS 2.0 specification</a> for details on each field in the header.</p>

<h3 id="test-mounting-our-luks-encrypted-partition">Test mounting our LUKS Encrypted Partition</h3>

<p>In order to reveal the contents of a LUKS encrypted disk, we must call <code>cryptsetup luksOpen</code> subcommand, which maps the encrypted file system to a LVM logical device using the Linux device mapper. Remember that your block device name might be something other than <code>/dev/sdb</code>, so be sure to edit the command below with the correct device name.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo cryptsetup luksOpen /dev/sdb2 pinephone</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Enter passphrase for /dev/sdb2:</code></pre></div>
<p>This will map the name /dev/mapper/pinephone to the LVM device.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ls -lah /dev/mapper/pinephone</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">lrwxrwxrwx 1 root root 7 May  8 08:18 /dev/mapper/pinephone -&gt; ../dm-2</code></pre></div>
<p>To see a full list of logical devices that use the device mapper driver you can simply run <code>dmsetup ls</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo dmsetup ls</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">pinephone       (253:2)
crypt2  (253:1)
crypt1  (253:0)</code></pre></div>
<p>The <code>dmsetup info</code> command can be used to get more details about the device.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo dmsetup info pinephone</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Name:              pinephone
State:             ACTIVE
Read Ahead:        256
Tables present:    LIVE
Open count:        0
Event number:      0
Major, minor:      253, 2
Number of targets: 1
UUID: CRYPT-LUKS2-01c8d337e5504121ba3eaba823ee5c38-pinephone</code></pre></div>
<p>After the device has been decrypted, we still need to mount <code>/dev/mapper/pinephone</code> somewhere if we wish to interact with it using standard commands. I will just use <code>/mnt/usb</code> again because I am lazy ;-)</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo mount /dev/mapper/pinephone /mnt/usb
ls -lah /mnt/usb</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">total 93K
drwxr-xr-x 21 root root 4.0K May 24 14:15 .
drwxr-xr-x  4 root root    5 Oct 18  2018 ..
drwxr-xr-x  2 root root 4.0K May 24 14:11 bin
drwxr-xr-x  2 root root 4.0K May 24 14:15 boot
drwxr-xr-x  2 root root 4.0K May 24 14:11 dev
drwxr-xr-x 61 root root 4.0K May 24 14:13 etc
drwxr-xr-x  3 root root 4.0K May 24 14:15 home
drwxr-xr-x 14 root root 4.0K May 24 14:11 lib
drwx------  2 root root  16K May 24 14:15 lost+found
drwxr-xr-x  5 root root 4.0K May 24 14:11 media
drwxr-xr-x  7 root root 4.0K May 24 14:11 mnt
drwxr-xr-x  2 root root 4.0K May 24 14:11 opt
drwxr-xr-x  2 root root 4.0K May 24 14:11 proc
drwx------  2 root root 4.0K May 24 14:11 root
drwxr-xr-x  6 root root 4.0K May 24 14:11 run
drwxr-xr-x  2 root root 4.0K May 24 14:11 sbin
drwxr-xr-x  2 root root 4.0K May 24 14:11 srv
drwxr-xr-x  2 root root 4.0K May 24 14:11 sys
drwxrwxrwt  2 root root 4.0K May 24 14:13 tmp
drwxr-xr-x 10 root root 4.0K May 24 14:11 usr
drwxr-xr-x 13 root root 4.0K May 24 14:11 var</code></pre></div>
<p>Now is a good time to copy anything over from your computer that you would like on your phone. For example, if you chose not to allow <code>pmbootstrap</code> to copy your SSH keys when we <a href="#initialize-the-pmbootstrap-configuration-for-the-pinephone">initialized the pmbootstrap configuration for the pinephone</a>, now is your second chance. It is particularly valuable to copy the SSH keys over if you do not have a serial UART cable that adapts USB to a 3.5mm audio jack. Otherwise, you can wait until we get to the section on <a href="#configure-x-forwarding">configuring x-forwarding</a>.</p>

<p>Once you are finished, unmount the device and close the LUKS volume.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo umount /mnt/usb
sudo cryptsetup luksClose pinephone</code></pre></div>
<h2 id="ncurses-over-serial">NCurses Over Serial</h2>

<p>I wrote an article that covers how to <a href="https://bloggerbust.ca/post/my-first-experience-connecting-to-the-phinephone-via-serial-console/">connect to the PinePhone via serial console</a> using emacs <code>serial-term</code>. In this article we are going to be using <em>ncurses</em> applications which <a href="https://bloggerbust.ca/post/how-to-configure-minicom-to-connect-over-usb-serial-uart/#minicom-might-not-be-the-best-tool-for-the-job">can appear garbled</a> if unintended escape interpretation mangles byte sequences meant to be displayed as part of the the UI. I have written another article where I explain <a href="https://bloggerbust.ca/post/let-socket-cat-be-thy-glue-over-serial/">how to use SOcket CAT to relay STDIO and serial in raw mode</a> which solves this problem. I will be using <a href="http://www.dest-unreach.org/socat/">SOcket CAT</a> to connect to the PinePhone, if you would like to use a different tool then that is fine. Otherwise, take the time now to <a href="https://pkgs.org/search/?q=socat">install SOcket CAT for your distro</a> before moving on.</p>

<h2 id="boot-into-postmarketos">Boot into postmarketOS</h2>

<p>For this next part you will need a USB to 3.3V TTL converter that uses RS-232 for serial communication transmission and adapts to a 3.5mm audio jack. See <a href="https://bloggerbust.ca/post/my-first-experience-connecting-to-the-phinephone-via-serial-console/#connect-to-the-pinephone-over-uart">Connect to the PinePhone over UART</a> for some options.</p>

<p>With your PinePhone powered off, insert both your <em>SIM</em> card and your <em>SD</em> card into the appropriate sockets. Connect your PinePhone to your computer using your serial UART cable. You might notice a LED on the phone light red. Next, you will need to <a href="https://bloggerbust.ca/post/how-to-configure-minicom-to-connect-over-usb-serial-uart/#determine-the-device-name">determine the attached serial port</a> and ensure that your user has been added to the <a href="https://bloggerbust.ca/post/how-to-configure-minicom-to-connect-over-usb-serial-uart/#device-group-ownership">appropriate application group</a>. Now fire up your favourite terminal emulator and run the following command, taking care to replace the serial port name appropriately.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">socat -,rawer,escape=0x0f /dev/ttyUSB0,b115200,rawer</code></pre></div>
<p>Power on the PinePhone and wait for the input prompt on the phone&rsquo;s display to decrypt the disk. As long as you connected to the UART serial console before powering on the phone, you should see output similar to the following in the terminal session:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">DRAM: 2048 MiB
Trying to boot from MMC1
NOTICE:  BL31: v2.1(release):v3.10.0_rc3-151-ga4b61dc7d9
NOTICE:  BL31: Built : 16:21:59, Jun 12 2019
NOTICE:  BL31: Detected Allwinner A64/H64/R18 SoC (1689)
NOTICE:  BL31: Found U-Boot DTB at 0x40632d8, model: PinePhone
NOTICE:  BL31: PMIC: Detected AXP803 on RSB.


U-Boot 2020.04-rc3 (Mar 18 2020 - 13:16:10 +0000)

DRAM:  2 GiB
MMC:   Device &#39;mmc@1c11000&#39;: seq 1 is in use by &#39;mmc@1c10000&#39;
mmc@1c0f000: 0, mmc@1c10000: 2, mmc@1c11000: 1
Loading Environment from FAT... Unable to use mmc 1:1... Hit any key to stop autoboot:  0
switch to partitions #0, OK
mmc0 is current device
Scanning mmc 0:1...
Found U-Boot script /boot.scr
949 bytes read in 1 ms (926.8 KiB/s)
## Executing script at 4fc00000
gpio: pin 98 (gpio 98) value is 1
gpio: pin 114 (gpio 114) value is 1
Booting from SD
arch=arm
baudrate=115200
board=sunxi
board_name=sunxi
boot_a_script=load ${devtype} ${devnum}:${distro_bootpart} ${scriptaddr} ${prefix}${script}; source ${scriptaddr}
boot_extlinux=sysboot ${devtype} ${devnum}:${distro_bootpart} any ${scriptaddr} ${prefix}${boot_syslinux_conf}
boot_net_usb_start=usb start
boot_prefixes=/ /boot/
boot_script_dhcp=boot.scr.uimg
boot_scripts=boot.scr.uimg boot.scr
boot_syslinux_conf=extlinux/extlinux.conf
boot_targets=fel mmc_auto usb0
bootargs=init=/init.sh rw console=tty0 console=ttyS0,115200 no_console_suspend earlycon=uart,mmio32,0x01c28000 panic=10 consoleblank=0 loglevel=1 cma=256M PMOS_NO_OUTPUT_REDIRECT pmos_boot=/dev/mmcblk0p1 pmos_root=/dev/mmcblk0p2
bootcmd=run distro_bootcmd
bootcmd_fel=if test -n ${fel_booted} &amp;&amp; test -n ${fel_scriptaddr}; then echo &#39;(FEL boot)&#39;; source ${fel_scriptaddr}; fi
bootcmd_mmc0=devnum=0; run mmc_boot
bootcmd_mmc1=devnum=1; run mmc_boot
bootcmd_mmc_auto=if test ${mmc_bootdev} -eq 1; then run bootcmd_mmc1; run bootcmd_mmc0; elif test ${mmc_bootdev} -eq 0; then run bootcmd_mmc0; run bootcmd_mmc1; fi
bootcmd_usb0=devnum=0; run usb_boot
bootdelay=2
bootdev=0
bootfstype=ext4
bootm_size=0xa000000
console=ttyS0,115200
cpu=armv8
devplist=1
dfu_alt_info_ram=kernel ram 0x40080000 0x1000000;fdt ram 0x4FA00000 0x100000;ramdisk ram 0x4FE00000 0x4000000
distro_bootcmd=for target in ${boot_targets}; do run bootcmd_${target}; done
distro_bootcmd=for target in ${boot_targets}; do run bootcmd_${target}; done
ethaddr=02:ba:3a:fe:45:68
fdt_addr_r=0x4FA00000
fdtcontroladdr=bbf4ed50
fdtfile=allwinner/sun50i-a64-pinephone.dtb
fileaddr=4fc00000
filesize=3b5
kernel_addr_r=0x40080000
mmc_boot=if mmc dev ${devnum}; then devtype=mmc; run scan_dev_for_boot_part; fi
mmc_bootdev=0
partitions=name=loader1,start=8k,size=32k,uuid=${uuid_gpt_loader1};name=loader2,size=984k,uuid=${uuid_gpt_loader2};name=esp,size=128M,bootable,uuid=${uuid_gpt_esp};name=system,size=-,uuid=${uuid_gpt_system};
preboot=usb start
pxefile_addr_r=0x4FD00000
ramdisk_addr_r=0x4FE00000
scan_dev_for_boot=echo Scanning ${devtype} ${devnum}:${distro_bootpart}...; for prefix in ${boot_prefixes}; do run scan_dev_for_extlinux; run scan_dev_for_scripts; done;
scan_dev_for_boot_part=part list ${devtype} ${devnum} -bootable devplist; env exists devplist || setenv devplist 1; for distro_bootpart in ${devplist}; do if fstype ${devtype} ${devnum}:${distro_bootpart} bootfstype; then run scan_dev_for_boot; fi; done; setenv devplist
scan_dev_for_extlinux=if test -e ${devtype} ${devnum}:${distro_bootpart} ${prefix}${boot_syslinux_conf}; then echo Found ${prefix}${boot_syslinux_conf}; run boot_extlinux; echo SCRIPT FAILED: continuing...; fi
scan_dev_for_scripts=for script in ${boot_scripts}; do if test -e ${devtype} ${devnum}:${distro_bootpart} ${prefix}${script}; then echo Found U-Boot script ${prefix}${script}; run boot_a_script; echo SCRIPT FAILED: continuing...; fi; done
scriptaddr=0x4FC00000
serial#=92c002ba3afe4568
soc=sunxi
stderr=serial@1c28000
stdin=serial@1c28000
stdout=serial@1c28000
usb_boot=usb start; if usb dev ${devnum}; then devtype=usb; run scan_dev_for_boot_part; fi
uuid_gpt_esp=c12a7328-f81f-11d2-ba4b-00a0c93ec93b
uuid_gpt_system=b921b045-1df0-41c3-af44-4c6f280d3fae

Environment size: 3158/131068 bytes
Loading DTB
33835 bytes read in 4 ms (8.1 MiB/s)
Loading Initramfs
1426778 bytes read in 76 ms (17.9 MiB/s)
Loading Kernel
15601672 bytes read in 690 ms (21.6 MiB/s)
gpio: pin 115 (gpio 115) value is 1
Resizing FDT
Booting kernel
gpio: pin 116 (gpio 116) value is 1
gpio: pin 98 (gpio 98) value is 0
## Loading init Ramdisk from Legacy Image at 4fe00000 ...
   Image Name:   uInitrd
   Image Type:   AArch64 Linux RAMDisk Image (uncompressed)
   Data Size:    1426714 Bytes = 1.4 MiB
   Load Address: 00000000
   Entry Point:  00000000
   Verifying Checksum ... OK
## Flattened Device Tree blob at 4fa00000
   Booting using the fdt blob at 0x4fa00000
   Loading Ramdisk to 49ea3000, end 49fff51a ... OK
   Loading Device Tree to 0000000049e97000, end 0000000049ea2fff ... OK

Starting kernel ...

[    0.000000] Booting Linux on physical CPU 0x0000000000 [0x410fd034]
[    0.000000] Linux version 5.6.0 (pmos@build) (gcc version 9.3.0 (Alpine 9.3.0)) #2-postmarketos-allwinner SMP Mon May 11 18:30:53 UTC 2020
[    0.000000] Machine model: Pine64 PinePhone Braveheart (1.1)
[    0.000000] earlycon: uart0 at MMIO32 0x0000000001c28000 (options &#39;&#39;)
[    0.000000] printk: bootconsole [uart0] enabled
### postmarketOS initramfs ###
Configuring kernel firmware image search path
modprobe: module sun6i_mipi_dsi not found in modules.dep
modprobe: module sun4i_drm not found in modules.dep
modprobe: module pwm_sun4i not found in modules.dep
modprobe: module sun8i_mixer not found in modules.dep
modprobe: module ext4 not found in modules.dep
modprobe: module usb_f_rndis not found in modules.dep
NOTE: Waiting 10 seconds for the framebuffer /dev/fb0.
If your device does not have a framebuffer, disable this with:
no_framebuffer=true in &lt;https://postmarketos.org/deviceinfo&gt;
Setting framebuffer mode to: U:720x1440p-0
Setup usb network
  /sys/class/android_usb does not exist, skipping android_usb
  Setting up an USB gadget through configfs
Starting udhcpd
  Using interface usb0
  Start the dhcpcd daemon (forks into background)
Mount boot partition (/dev/mmcblk0p1)
Extract /boot/initramfs-postmarketos-allwinner-extra
32175 blocks</code></pre></div>
<p>The last line of output should indicate the number of blocks on the device. If your serial connection was not established before booting the PinePhone, then you will not see the output above. In that case, don&rsquo;t fret and continue reading.</p>

<p>At this point, the <em>initramfs</em> is waiting for the passphrase required to unlock the encrypted root filesystem. The PinePhone screen should now be displaying an input field to enter the passphrase as well as a full virtual keyboard. Remember that you have two passwords; one is for opening the LUKS encrypted partition and the other is a simple numeric pin that is actually your postmarketOS user account password.</p>

<p>Enter your password for disk decryption. The initramfs will then open the LUKS encrypted file system and continue with the boot process. You will see output similar to the following in your serial console screen.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Check/repair root filesystem (/dev/mapper/root)
e2fsck 1.45.6 (20-Mar-2020)
pmOS_root: clean, 51568/3899392 files, 664293/15567360 blocks
Resize root filesystem (/dev/mapper/root)
resize2fs 1.45.6 (20-Mar-2020)
The filesystem is already 15567360 (4k) blocks long.  Nothing to do!

Mount root partition (/dev/mapper/root)
umount: can&#39;t unmount /dev: Invalid argument

   OpenRC 0.42.1.ea8a00c524 is starting up Linux 5.6.0 (aarch64)

/lib/rc/sh/init.sh: line 15: can&#39;t create /dev/null: Read-only file system
 * md5sum is missing, which suggests /usr is not mounted
 * If you have separate /usr, it must be mounted by initramfs
 * If not, you should check coreutils is installed correctly
 * Mounting /proc ... [ ok ]
 * Mounting /run ... * /run/openrc: creating directory
 * /run/lock: creating directory
 * /run/lock: correcting owner
/lib/rc/sh/gendepends.sh: line 28: can&#39;t create /dev/null: Read-only file system
 * Caching service dependencies ... [ ok ]
 * Clock skew detected with `(null)&#39;
 * Adjusting mtime of `/run/openrc/deptree&#39; to Sun May 24 20:11:53 2020

 * WARNING: clock skew detected!
 * Mounting devtmpfs on /dev ... [ ok ]
 * Mounting /dev/mqueue ... [ ok ]
 * Mounting /dev/pts ... [ ok ]
 * Mounting /dev/shm ... [ ok ]
 * Mount subpartitions of /dev/mmcblk0
device-mapper: reload ioctl on mmcblk0p1  failed: Resource busy
create/reload failed on mmcblk0p1
device-mapper: reload ioctl on mmcblk0p2  failed: Resource busy
create/reload failed on mmcblk0p2
 * Mount subpartitions of /dev/mmcblk2
 * Mounting /sys ... [ ok ]
 * Mounting security filesystem ... [ ok ]
 * Mounting debug filesystem ... [ ok ]
 * Mounting config filesystem ... [ ok ]
 * Mounting fuse control filesystem ... [ ok ]
 * Starting udev ... [ ok ]
 * Generating a rule to create a /dev/root symlink ... [ ok ]
 * Populating /dev with existing devices through uevents ... [ ok ]
 * WARNING: clock skew detected!
 * Loading modules ... [ ok ]
 * Setting system clock using the hardware clock [UTC] ... [ ok ]
 * Checking local filesystems  .../dev/mmcblk2p2 is in use.
e2fsck: Cannot continue, aborting.


 * Operational error
 [ !! ]
 * Remounting root filesystem read/write ... [ ok ]
 * Remounting filesystems ... [ ok ]
 * Mounting local filesystems ... [ ok ]
 * Configuring kernel parameters ...sysctl: error: &#39;net.ipv4.tcp_syncookies&#39; is an unknown key
sysctl: error: &#39;kernel.unprivileged_bpf_disabled&#39; is an unknown key
sysctl: error: &#39;kernel.sysrq&#39; is an unknown key
 [ ok ]
 * Migrating /var/lock to /run/lock ... [ ok ]
 * Creating user login records ... [ ok ]
 * Wiping /tmp directory ... [ ok ]
 * Setting hostname ... [ ok ]
 * Starting busybox syslog ... [ ok ]
 * WARNING: clock skew detected!
 * Starting System Message Bus ... [ ok ]
 * Starting RNG Daemon ... [ ok ]
 * Starting WPA Supplicant ... [ ok ]
 * Starting networkmanager ... [ ok ]
 * Starting chronyd ... [ ok ]
 * Enabling EG25 WWAN module ... * Starting gpsd ... [ ok ]
 * /run/lightdm: creating directory
 * /run/lightdm: correcting owner
 * Starting Display Manager ... [ ok ]
 * Starting pinephone_setup-modem-audio ... * command_background option used but no pidfile specified
 [ !! ]
 * ERROR: pinephone_setup-modem-audio failed to start
 * Starting oFono ... [ ok ]
 * Starting ofono-auto-enable ... [ ok ]
ssh-keygen: generating new host keys: RSA DSA ECDSA ED25519
 * Starting sshd ... [ ok ]
 * Activating swap file ...Configured swap file size is 0, skipping creation.
 [ ok ]
 * Starting urfkill ... [ ok ]
 * Starting local ... [ ok ]

Welcome to postmarketOS
Kernel 5.6.0 on an aarch64 (/dev/ttyS0)
second-chance login:</code></pre></div>
<p>You might notice some errors in the output. This is a work in progress and eventually those sorts of issues will be taken care of. Notice that the serial port that the login session is connected to on the device side is displayed in the welcome message above. You may now sign in by entering your user name and pin.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Welcome to postmarketOS
Kernel 5.6.0 on an aarch64 (/dev/ttyS0)
second-chance login: dustfinger
Password:
Welcome to postmarketOS!

This distribution is based on Alpine Linux.
Read both our wikis to find a large amount of how-to guides and
general information about administrating and development.
See &lt;https://wiki.postmarketos.org&gt; and &lt;https://wiki.alpinelinux.org&gt;.

You may change this message by editing /etc/motd.

second-chance:~$</code></pre></div>
<p>Once signed in, you will probably be interested in knowing that the PostmarketOS default shell is ash (<a href="https://www.in-ulm.de/~mascheck/various/ash/">Almquist Shell</a>). If you are familiar with bash, you should feel right at home with ash since it is essentially a light weight fork.</p>

<h2 id="resize-the-screen">Resize the screen</h2>

<p>The device side has no way of knowing the size of the terminal display. Use the <code>stty</code> command (see <a href="https://linux.die.net/man/1/stty">stty(1)</a>) to print the number of rows and columns that the phone&rsquo;s kernel thinks that your terminal has.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ stty size</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">52 80</code></pre></div>
<p>To set a specific number of rows and columns you can use <code>stty rows 56 columns 192</code>. If you are not sure the true number of rows and columns that your terminal has, you can simply run the <code>resize</code> (see <a href="https://linux.die.net/man/1/resize">resize(1)</a>) command.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ resize</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">COLUMNS=191;LINES=56;export COLUMNS LINES;</code></pre></div>
<p>I have found that I need to run <code>resize</code> each time I connect over serial. Be sure to set the size again if the terminals dimensions change at any point. This could be automated, but I won&rsquo;t be covering automation of screen resizing in this post.</p>

<h2 id="set-the-timezone-date-and-time">Set the timezone, date &amp; time</h2>

<p>For some reason pmbootstrap did not detect the timezone of the host machine, that means I will need to set it manually. Unfortunately, I was not able to do this with the Plasma Mobile UI. The date controls seem to not be integrated yet. Thankfully, setting the timezone, date and time is straight forward to do via command line.</p>

<p>We can use the date command to find out what the current timezone, date and time are set to.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ date</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Sat Apr 11 18:19:04 GMT 2020</code></pre></div>
<p>If pmbootstrap cannot determine your host&rsquo;s timezone, then it will default to GMT (Greenwich Mean Time).</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ls -la /etc/localtime</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">lrwxrwxrwx    1 root     root            17 Apr 12  2020 /etc/localtime -&gt; /etc/zoneinfo/GMT</code></pre></div>
<p>To set the timezone, we simply need to update the <code>/etc/localtime</code> soft link to point to the correct timezone information file in <code>/usr/share/zoneinfo/</code>. The timezone information file is a binary file, if you are curious about its format, refer to the <a href="https://linux.die.net/man/5/tzfile">tzfile(5)</a> man page.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo ln -snf -T /usr/share/zoneinfo/Canada/Mountain /etc/localtime
second-chance:~$ ls -la /etc/localtime</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">lrwxrwxrwx    1 root     root            35 Apr 11 12:35 /etc/localtime -&gt; /usr/share/zoneinfo/Canada/Mountain</code></pre></div>
<p>Finally, we can set the current date and time with the date command (see <a href="https://man7.org/linux/man-pages/man1/date.1.html">date(1)</a>). The date command accepts a date in the following format: <code>[MMDDhhmm[[CC]YY][.ss]]</code>. The square brackets indicate optional date and time information. Enter the current date and time, then press <code>&lt;RET&gt;</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo date <span style="color:#3677a9">052506302020</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[sudo] password for dustfinger:
Mon May 25 06:30:00 MDT 2020</code></pre></div>
<p>Now, if you run the date command again with no parameters, the correct date, time and timezone should be displayed.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ date</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Mon May 25 06:30:25 MDT 2020</code></pre></div>
<p>Don&rsquo;t worry about getting the time set with a high degree of precision. There is chron job configured to correct time drift via <em>NTP</em>. See <code>/etc/chrony/chron.conf</code>.</p>

<h2 id="what-s-in-the-default-runlevel">What&rsquo;s in the default runlevel?</h2>

<p>This is a newly installed system that I did not fully configure myself. I would like to know what is registered with the default runlevel. PostmarketOS uses OpenRC init system, so to answer my question we can make use of the <code>rc-update</code> command (see <a href="https://manpages.debian.org/testing/openrc/rc-update.8.en.html">rc-update(8)</a>).</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ rc-update show default</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">             chronyd | default
                dbus | default
                eg25 | default
                gpsd | default
      gpsd_pinephone | default
             haveged | default
             lightdm | default
               local | default
      networkmanager | default
               ofono | default
   ofono-auto-enable | default
pinephone_setup-modem-audio | default
                sshd | default
            swapfile | default
      udev-postmount | default
             urfkill | default
      wpa_supplicant | default</code></pre></div>
<p>I do not have an immediate need for the ssh daemon (<code>sshd</code>), so I am going to delete that from the default runlevel. Otherwise, I am happy with what is currently registered.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-update del sshd default</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for dustfinger:
 * service sshd removed from runlevel default</code></pre></div>
<p>The daemon will remain running until I reboot the system or explicitly stop the service. There is no sense in leaving it running.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service sshd stop</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* Stopping sshd ...                  [ ok ]</code></pre></div>
<h2 id="improve-our-getty-configuration">Improve our getty configuration</h2>

<p>In order to have a modern terminal experience over the serial connection, we need to modify the terminal capabilities of the <code>TTY</code> at the login prompt. To accomplish that, we first need to select a <em>Terminfo</em> (see <a href="https://linux.die.net/man/5/terminfo">terminfo(5)</a>, <a href="https://linux.die.net/HOWTO/Text-Terminal-HOWTO-16.html#ss16.1">Intro to Terminfo</a>) which meets our requirements.</p>

<p>To see the currently selected <em>Terminfo</em> output the value of the <a href="https://linux.die.net/HOWTO/Text-Terminal-HOWTO-16.html#ss16.6">TERM environment variable</a>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ <span style="color:#24909d">echo</span> <span style="color:#40ffff">$TERM</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">vt100</code></pre></div>
<p>The <code>getty</code> command that opens the login <code>TTY</code> with the <em>vt100</em> Terminfo is located in <code>/etc/inittab/</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ grep -iE <span style="color:#ed9d13">&#39;ttyS0.*vt100&#39;</span> /etc/inittab</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">ttyS0::respawn:/sbin/getty -L ttyS0 115200 vt100</code></pre></div>
<p>Here is the full list of valid <code>Terminfo</code> names supported by the PinePhone:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ls -lh /etc/terminfo/**/*</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">-rw-r--r--    1 root     root        3.5K May 24  2020 /etc/terminfo/a/alacritty
-rw-r--r--    1 root     root        1.4K May 24  2020 /etc/terminfo/a/ansi
-rw-r--r--    1 root     root         308 May 24  2020 /etc/terminfo/d/dumb
-rw-r--r--    1 root     root        3.0K May 24  2020 /etc/terminfo/g/gnome
-rw-r--r--    1 root     root        3.2K May 24  2020 /etc/terminfo/g/gnome-256color
-rw-r--r--    1 root     root        2.8K May 24  2020 /etc/terminfo/k/kitty
-rw-r--r--    1 root     root        3.1K May 24  2020 /etc/terminfo/k/konsole
-rw-r--r--    1 root     root        3.2K May 24  2020 /etc/terminfo/k/konsole-256color
-rw-r--r--    1 root     root        1.8K May 24  2020 /etc/terminfo/k/konsole-linux
-rw-r--r--    1 root     root        1.7K May 24  2020 /etc/terminfo/l/linux
-rw-r--r--    1 root     root        2.1K May 24  2020 /etc/terminfo/p/putty
-rw-r--r--    1 root     root        2.2K May 24  2020 /etc/terminfo/p/putty-256color
-rw-r--r--    1 root     root        2.2K May 24  2020 /etc/terminfo/r/rxvt
-rw-r--r--    1 root     root        2.4K May 24  2020 /etc/terminfo/r/rxvt-256color
-rw-r--r--    1 root     root        1.5K May 24  2020 /etc/terminfo/s/screen
-rw-r--r--    1 root     root        1.7K May 24  2020 /etc/terminfo/s/screen-256color
-rw-r--r--    1 root     root        2.3K May 24  2020 /etc/terminfo/s/st-0.6
-rw-r--r--    1 root     root        2.6K May 24  2020 /etc/terminfo/s/st-0.7
-rw-r--r--    1 root     root        2.5K May 24  2020 /etc/terminfo/s/st-0.8
-rw-r--r--    1 root     root        2.7K May 24  2020 /etc/terminfo/s/st-16color
-rw-r--r--    1 root     root        2.6K May 24  2020 /etc/terminfo/s/st-256color
-rw-r--r--    1 root     root        2.6K May 24  2020 /etc/terminfo/s/st-direct
-rw-r--r--    1 root     root        1004 May 24  2020 /etc/terminfo/s/sun
-rw-r--r--    1 root     root        1.7K May 24  2020 /etc/terminfo/t/terminator
-rw-r--r--    1 root     root        3.0K May 24  2020 /etc/terminfo/t/terminology
-rw-r--r--    1 root     root        2.3K May 24  2020 /etc/terminfo/t/terminology-0.6.1
-rw-r--r--    1 root     root        3.0K May 24  2020 /etc/terminfo/t/terminology-1.0.0
-rw-r--r--    1 root     root        3.0K May 24  2020 /etc/terminfo/t/tmux
-rw-r--r--    1 root     root        3.1K May 24  2020 /etc/terminfo/t/tmux-256color
-rw-r--r--    1 root     root        1.2K May 24  2020 /etc/terminfo/v/vt100
-rw-r--r--    1 root     root        1.2K May 24  2020 /etc/terminfo/v/vt102
-rw-r--r--    2 root     root        1.3K May 24  2020 /etc/terminfo/v/vt200
-rw-r--r--    2 root     root        1.3K May 24  2020 /etc/terminfo/v/vt220
-rw-r--r--    1 root     root         839 May 24  2020 /etc/terminfo/v/vt52
-rw-r--r--    1 root     root        3.2K May 24  2020 /etc/terminfo/v/vte
-rw-r--r--    1 root     root        3.4K May 24  2020 /etc/terminfo/v/vte-256color
-rw-r--r--    1 root     root        3.6K May 24  2020 /etc/terminfo/x/xterm
-rw-r--r--    1 root     root        3.7K May 24  2020 /etc/terminfo/x/xterm-256color
-rw-r--r--    1 root     root        1.5K May 24  2020 /etc/terminfo/x/xterm-color
-rw-r--r--    1 root     root        2.2K May 24  2020 /etc/terminfo/x/xterm-xfree86</code></pre></div>
<p>It is important that you set a Terminfo that is compatible with the terminal emulator that you will be using when connecting to the PinePhone over serial. Since I am running <code>xterm</code>, one of the names under <code>/etc/terminfo/x/</code> would be appropriate, but what if one day I need to login using <code>tmux</code>? That is why <code>vt100</code> was chosen, it is compatible with a large variety of terminal emulators. A more modern, and reasonably safe, alternative is <code>/etc/terminfo/l/linux</code> and is another common default for <code>getty</code> over serial. I recommend testing a few of them out to help you make the best decision. To do that, you can set the <code>TERM</code> environment variable for the lifetime of a single command using <code>env</code>. To put our <code>terminfo</code> of choice to the test, we can use the <code>nmtui</code> command. First run <code>nmtui</code> without modifying the Terminfo so that you have a basis by which to compare, then try out a few reasonable options.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">env <span style="color:#40ffff">TERM</span>=linux nmtui</code></pre></div>
<p>Choosing an incompatible Terminfo when running <code>nmtui</code> may result in problems ranging from unexpected behaviour, to a completely garbled and totally unusable ncurses UI. If you run into problems, remember that you can send a <code>SIGINT</code> to <code>nmtui</code> that will cause it to exit and return control to the command line prompt. Exactly how you send the <code>SIGINT</code> will depend on how you established your serial connection in the first place. Assuming that you followed along and ran the same <code>socat</code> command that I did, then you can send a SIGINT by pressing <code>ESC ESC</code>.</p>

<p>Some of the issues that you might run into may be subtle. For example, linux, xterm, xterm-color and xterm-xfree86 Terminfo generally all worked well during my testing, but the first screen of <code>nmtui</code> was always drawn twice. I even notice some artifacts while the screen is being rendered when using <code>xterm-color</code>. However; xterm-256color renders the screen only once and seems much faster to navigate. The fastest Terminfo by far is vt100, but it lacks color which is nice for screen shots ;-)</p>

<p>Once you have made your decision, use <code>vi</code> to edit <code>/etc/inittab</code> and locate the <code>getty</code> command which opens <code>/dev/ttyS0</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo vi /etc/inittab</code></pre></div>
<p>Replace <code>vt100</code> in that command with your chosen Terminfo. Or, if you are feeling confident, you can simply use <code>sed</code> (see <a href="https://man7.org/linux/man-pages/man1/sed.1.html">sed(1)</a>). A backup will be saved to <code>/etc/inittab.bk</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sed -i <span style="color:#ed9d13">&#39;s/ttyS0 115200 vt100/ttyS0 115200 xterm-256color/&#39;</span> /etc/inittab</code></pre></div>
<p>On your next reboot the Terminfo for the login session will be as you set it. I would rather not reboot now though, so let&rsquo;s change our Terminfo for the current session by exporting a new value for the <code>TERM</code> environment variable.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#24909d">export</span> <span style="color:#40ffff">TERM</span>=xterm-256color</code></pre></div>
<h2 id="configuring-wifi">Configuring Wifi</h2>

<p>PostmarketOS uses the NetworkManager daemon for configuring network interfaces. A simple way to configure the PinePhone&rsquo;s wireless network interface is to use the Network Manager Text-based User Interface command named <code>nmtui</code>. I will be walking through one possible configuration for setting up Wi-Fi, but your local area network might require that you choose different configuration options other than the ones shown here. Please keep that in mind if you are following along, and choose the options that make the most sense for your local environment.</p>

<p>Before we get started, we need to determine the name of the wireless interface. We can do that by using the <code>find</code> command (see <a href="https://man7.org/linux/man-pages/man1/find.1.html">find(1)</a>) to search for a directory named <em>wireless</em> under <code>/sys/class/net/</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo find -L /sys/class/net/ -maxdepth <span style="color:#3677a9">2</span> -type d -name <span style="color:#ed9d13">&#39;wireless&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/sys/class/net/wlan0/wireless</code></pre></div>
<p>We can see that there is one wireless network interface named <code>wlan0</code>. Now we can use the <code>ip</code> CLI (see <a href="https://man7.org/linux/man-pages/man8/ip.8.html">ip(8)</a>) to show us some information about the interface.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ip addr show wlan0</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">3: wlan0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state DOWN qlen 1000
    link/ether bf:72:de:21:38:51 brd ff:ff:ff:ff:ff:ff</code></pre></div>
<p>The wireless interface is currently down. Now we are ready to configure a new network connection for the wireless interface.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ nmtui edit</code></pre></div>
<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/nmtui-edit-menu-no-connections-configured.png"/> 
</figure>


<p>The network configuration edit menu appears displaying a list of configured network connections. If this is your first time configuring a network connection, then the selection list will be empty as shown in the screen shot above. Press <code>&lt;TAB&gt;</code> so that the <code>&lt;Add&gt;</code> button is highlighted, then hit enter.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/nmtui-new-connection-menu.png"/> 
</figure>


<p>The <em>New Connection</em> menu appears. Select <em>Wi-Fi</em> from the list of connection types and then press <code>&lt;TAB&gt;</code> until the <code>&lt;Create&gt;</code> navigation control is highlighted, then press <code>&lt;RET&gt;</code>.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/nmtui-edit-connection-menu-initial-state.png"/> 
</figure>


<p>Now that the type of connection has been decided we have arrived at the <em>Edit Connection</em> dialog. I will walk through filling out a possible valid configuration. Enter the following fields:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Profile name: Hidden SSID
Device: wlan0
SSID: HiddenSSID
Mode: &lt;Client&gt;
Security: WPA &amp; WPA2 Personal
Password: &lt;YOUR PASSWORD&gt;
BSSID: f2:33:7c:80:ba:d1</code></pre></div>
<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/nmtui-edit-connection-menu-filled-in.png"/> 
</figure>


<p>This is a simple configuration, I left all fields not explicitly mentioned to their default values. However; I recommend that you review all the configuration options available and choose the most secure settings that your router is capable of providing. Once you are happy with your choices, press <code>&lt;TAB&gt;</code> until the <code>&lt;OK&gt;</code> navigation control is highlighted and hit <code>&lt;RET&gt;</code>.</p>

<p>Look at the display on your phone. If the screen has locked, you will need to enter your pin in order to unlock it. The display should be showing a dialog prompting you to set a password for the KDE wallet. I entered a strong password and pressed the OK button. Do not choose the same password that you used for encrypting the root file system. It should also go without saying that you should not use the same password as your user&rsquo;s PIN.</p>

<p>Now draw your attention back to your serial console session.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/nmtui-edit-menu-showing-configured-connection.png"/> 
</figure>


<p>The UI should be back at the screen for selecting a network connection. The network selection box is no longer empty, it contains a single Wi-Fi connection with the profile name <em>Hidden SSID</em>. Hit the <code>&lt;TAB&gt;</code> key until <code>&lt;Quit&gt;</code> is highlighted, then press <code>&lt;RET&gt;</code> to exit <code>nmtui</code>.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/nmtui-edit-connection-menu-filled-in.png"/> 
</figure>


<p>The configuration is saved to <code>/etc/NetworkManager/system-connection/</code>.</p>

<p>From the console, use the <code>nmcli</code> to see the connection.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">second-chance:~$ nmcli connection show
NAME         UUID                                  TYPE  DEVICE
Hidden SSID  b6e9fa71-9828-4912-9d8c-456be04e2a11  wifi  --</code></pre></div>
<p>Use the <code>nmcli con up</code> command to start the Wi-Fi connection.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ nmcli con up Hidden<span style="color:#ed9d13">\ </span>SSID</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/1)</code></pre></div>
<p>If everything worked as intended, the <code>wlan0</code> interface should now have an IP address.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ip addr show wlan0</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">5: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
    link/ether 08:c1:de:23:02:10 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.102/24 brd 192.168.1.255 scope global dynamic wlan0
       valid_lft 43065sec preferred_lft 43065sec
    inet6 efbd:3669:1d6c::ddf/128 scope global
       valid_lft forever preferred_lft forever
    inet6 efbd:3669:1d6c:0:7858:df42:e675:c583/64 scope global secondary dynamic
       valid_lft 604662sec preferred_lft 86254sec
    inet6 efbd:3669:1d6c:0:40c5:90e8:8190:64e8/64 scope global
       valid_lft forever preferred_lft forever
    inet6 ed63::28bc:a402:2d51:11d/64 scope link
       valid_lft forever preferred_lft forever</code></pre></div>
<p>Try pinging a domain on the internet that you know responds to ICMP echo requests.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ping bloggerbust.ca -c <span style="color:#3677a9">3</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">PING bloggerbust.ca (185.199.111.153): 56 data bytes
64 bytes from 185.199.111.153: seq=0 ttl=42 time=27.402 ms
64 bytes from 185.199.111.153: seq=1 ttl=42 time=28.191 ms
64 bytes from 185.199.111.153: seq=2 ttl=42 time=27.031 ms

--- bloggerbust.ca ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 27.031/27.541/28.191 ms</code></pre></div>
<p>You should now be able to enable and disable Wi-Fi using the <em>Quick Settings Tray</em>.</p>

<h2 id="ntp-time-syncing">NTP time syncing</h2>

<p>Before continuing, please check the <a href="http://support.ntp.org/bin/view/Main/SecurityNotice#Recent%5FVulnerabilities">ntp security notice</a> page for news about recent vulnerabilities and mitigation&rsquo;s. NTP is already configured.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ cat /etc/conf.d/ntpd</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># By default ntpd runs as a client. Add -l to run as a server on port 123.
NTPD_OPTS=&#34;-N -p pool.ntp.org&#34;</code></pre></div>
<p>The <code>chronyd</code> is configured to monitor drift and perform the sync when necessary.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cat /etc/chrony/chrony.conf</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># default config

pool pool.ntp.org iburst
#initstepslew 10 pool.ntp.org
driftfile /var/lib/chrony/chrony.drift
rtcsync
cmdport 0
makestep 1 -1</code></pre></div>
<p>So if there is nothing to do, then why did I include a section on NTP at all? Well, as you have been made aware, NTP has known vulnerabilities. These vulnerabilities can be mitigated, but I felt it was important to raise awareness about the issue. Now that you are aware that there are issues, perhaps you will want to <a href="https://tor.stackexchange.com/questions/3754/what-is-the-recommended-way-for-handling-ntp#3755">handle NTP differently over Tor</a>. Consider the possibility of somehow using time skew corrections to deanonymize unsuspecting travellers on <a href="https://www.torproject.org/">the Tor network</a>; perhaps through some sort of fuzzy fingerprinting technique. That is all speculation of course, this is a subject matter that I have much to learn about. At any rate, it is never a waste of time to learn more about how your system is configured, especially when that system is societies primary form of communication.</p>

<p>See also <a href="https://tails.boum.org/contribute/design/Time%5Fsyncing/">Tails Time syncing</a>.</p>

<h2 id="update-apk-index">Update APK Index</h2>

<p>You are probably aware that postmarketOS is based on Alpine Linux. The <a href="https://wiki.alpinelinux.org/wiki/Alpine%5FLinux%5Fpackage%5Fmanagement">package management tool for Alpine Linux</a> is called <code>apk</code>. Now that we have an network connection, it is a good time to update the index of available packages. You need to run the <code>apk update</code> command at least once, before you can use any of the sub commands that rely on the index. This is what you will see if you try to run <code>apk info</code> prior to downloading the index.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ apk info vi</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">WARNING: Ignoring APKINDEX.3f9c67ba.tar.gz: No such file or directory
WARNING: Ignoring APKINDEX.066df28d.tar.gz: No such file or directory
WARNING: Ignoring APKINDEX.b53994b4.tar.gz: No such file or directory
WARNING: Ignoring APKINDEX.30e6f5af.tar.gz: No such file or directory</code></pre></div>
<p>Let&rsquo;s update the index by running <code>apk update</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo apk update</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">fetch http://postmarketos1.brixit.nl/postmarketos/master/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/main/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/community/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/testing/aarch64/APKINDEX.tar.gz
2020-04-20 02:19:35.767440 [http://postmarketos1.brixit.nl/postmarketos/master]
v20200319-2692-g0c35cac407 [http://dl-cdn.alpinelinux.org/alpine/edge/main]
v20200319-2699-gfec8fe13ff [http://dl-cdn.alpinelinux.org/alpine/edge/community]
v20200319-2697-g856e44244b [http://dl-cdn.alpinelinux.org/alpine/edge/testing]
OK: 16469 distinct packages available</code></pre></div>
<h2 id="configure-logging">Configure Logging</h2>

<p>Alpine Linux default logger is <a href="https://wiki.alpinelinux.org/wiki/Syslog#busybox%5Fsyslog">busybox syslog</a>. You can find the log configuration at <code>/etc/conf.d/syslog</code>. Run <code>syslogd --help</code> for configuration options. Busybox syslog is simple to configure, but I prefer a logging facility that is more customizable. <a href="https://www.syslog-ng.com/products/open-source-log-management/">Syslog-ng</a> is also easy to configure, and it offers the ability to direct logging to appropriately named files which will keep your logs organized and make it easier to find what you are looking for. Perhaps the same is possible with <code>syslogd</code>, but it wasn&rsquo;t immediately clear to me how to do that.</p>

<p>To install <code>syslog-ng</code> run:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo apk add syslog-ng</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(1/3) Installing ivykis (0.42.4-r0)
(2/3) Installing syslog-ng (3.27.1-r0)
Executing syslog-ng-3.27.1-r0.post-install
(3/3) Installing syslog-ng-openrc (3.27.1-r0)
Executing busybox-1.31.1-r16.trigger
Executing postmarketos-base-3-r34.trigger
Configuring a getty on port ttyS0 with baud rate 115200
OK: 1358 MiB in 597 packages</code></pre></div>
<p>You can find the configuration for <code>syslog-ng</code> in <code>/etc/syslog-ng/syslog-ng.conf</code>, but I think the default configuration is quite good, so I am going to leave it as is.</p>

<p>Delete <code>syslog</code> from the boot runlevel.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-update del syslog boot</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* service syslog removed from runlevel boot</code></pre></div>
<p>Stop the <code>syslog</code> daemon.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service syslog stop</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* Caching service dependencies ...            [ ok ]
* Stopping busybox syslog ...</code></pre></div>
<p>Add <code>syslog-ng</code> to the boot runlevel.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-update add syslog-ng boot</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* service syslog-ng added to runlevel boot</code></pre></div>
<p>Start the <code>syslog-ng</code> daemon.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service syslog-ng start</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* Starting syslog-ng ...</code></pre></div>
<p>You should start to see more log files showing up in <code>/var/log</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ls -lah /var/log/</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">total 44K
drwxr-xr-x    4 root     root        4.0K May 27 06:23 .
drwxr-xr-x   12 root     root        4.0K Dec 31  1969 ..
-rw-r--r--    1 root     root           0 May 27 05:53 auth.log
drwxr-sr-x    2 chrony   chrony      4.0K May 24 14:11 chrony
-rw-r-----    1 root     root       22.8K May 26 03:43 dmesg
-rw-r--r--    1 root     root           0 May 27 05:53 error.log
-rw-r--r--    1 root     root           0 May 27 05:53 kern.log
drwx--x--x    2 root     root        4.0K May 26 03:43 lightdm
-rw-r--r--    1 root     root           0 May 27 05:53 mail.log
-rw-r-----    1 root     adm           84 May 27 06:23 messages
-rw-rw-r--    1 root     utmp           0 Dec 31  1969 wtmp</code></pre></div>
<h2 id="upgrade-to-latest-repository">Upgrade to latest repository</h2>

<p>You do not need to re-deploy with pmbootstrap to keep your system up to date with the latest repositories. Instead, on a daily basis, <a href="#update-apk-index">update the APK index</a> and run <code>apk upgrade</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo apk upgrade</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(1/11) Upgrading libgcc (9.3.0-r1 -&gt; 9.3.0-r2)
(2/11) Upgrading libstdc++ (9.3.0-r1 -&gt; 9.3.0-r2)
(3/11) Upgrading poppler-qt5 (0.88.0-r0 -&gt; 0.88.0-r1)
(4/11) Upgrading okular-common (20.04.0-r0 -&gt; 20.04.1-r0)
(5/11) Upgrading okular-mobile (20.04.0-r0 -&gt; 20.04.1-r0)
(6/11) Upgrading kirigami-gallery (20.04.0-r0 -&gt; 20.04.1-r0)
(7/11) Upgrading libgomp (9.3.0-r1 -&gt; 9.3.0-r2)
(8/11) Upgrading ktp-common-internals (20.04.0-r0 -&gt; 20.04.1-r0)
(9/11) Upgrading akonadi (20.04.0-r0 -&gt; 20.04.1-r0)
(10/11) Upgrading kmime (20.04.0-r0 -&gt; 20.04.1-r0)
(11/11) Upgrading akonadi-contacts (20.04.0-r0 -&gt; 20.04.1-r0)
Executing busybox-1.31.1-r15.trigger
Executing postmarketos-base-3-r33.trigger
Configuring a getty on port ttyS0 with baud rate 115200
Executing shared-mime-info-1.15-r0.trigger
Executing gtk-update-icon-cache-2.24.32-r1.trigger
OK: 1352 MiB in 591 packages</code></pre></div>
<p>However; <code>apk upgrade</code> will not update U-Boot. I might cover updating U-Boot in a future post.</p>

<h2 id="configure-x-forwarding">Configure x-forwarding</h2>

<p>Before we begin, I should mention that <a href="https://unix.stackexchange.com/questions/236482/is-there-a-downside-to-enabling-x11-forwarding-in-ssh">X-forwarding poses a security risk to the client side</a>. That said, there might be times when you would like to use a GUI app on your mobile phone, but the GUI wasn&rsquo;t designed for touch screens. For example, perhaps you would like to explore a dbus interface using <a href="https://github.com/GNOME/d-feet">dFeet</a>. Unfortunately dFeet does not have a CLI and is not mobile friendly. In such cases, I will start <code>sshd</code> on the PinePhone and use x-forwarding to my development box. Once I am finished, I always shut down <code>sshd</code>. No sense in leaving it running since I have <code>serial</code>.</p>

<p>First, let&rsquo;s configure the server side (PinePhone) by editing <code>/etc/ssh/sshd_config</code> (see <a href="http://man7.org/linux/man-pages/man5/sshd%5Fconfig.5.html">sshd_config(5)</a>).</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo vi /etc/ssh/sshd_config</code></pre></div>
<p>Page down to the bottom of the file and add the following conditional block which will override the system wide <code>X11Forwarding</code> and <code>X11UseLocalhost</code> settings for your user.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Match User dustfinger
  X11Forwarding yes
  X11UseLocalhost yes</code></pre></div>
<p>Start the SSH daemon.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service sshd start</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* Starting sshd ...                       [ ok ]</code></pre></div>
<p>If it is was already started, then you will have to restart it for the changes to take effect. Back on the client side, generate a new RSA key.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir -p ~/.ssh
ssh-keygen -f ~/.ssh/id_second-chance_rsa</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Generating public/private rsa key pair.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/dustfinger/.ssh/id_second-chance_rsa.
Your public key has been saved in /home/dustfinger/.ssh/id_second-chance_rsa.pub.
The key fingerprint is:
SHA256:3KcVsaPW0FxMatRMkX+/JKN21OPItaxi5P1wZBRliGo dustfinger@galactica
The key&#39;s randomart image is:
+---[RSA 3072]----+
|            oB==+|
|           +.=*..|
|          ..O  o |
|       . .E= o. o|
|        S.+ + .oo|
|         . = +o=.|
|          + =.O.+|
|           * =o= |
|          o o.o. |
+----[SHA256]-----+</code></pre></div>
<p>Edit <code>$HOME/.ssh/config</code> (see <a href="http://man7.org/linux/man-pages/man5/ssh%5Fconfig.5.html">ssh_config(5)</a>) creating a new file if it does not already exist. Add the following host specific configuration. Replace <code>second-chance</code> with the host name or IP address of your PinePhone.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">host second-chance
     Hostname second-chance
     ForwardAgent yes
     ForwardX11 yes
     # ForwardX11Trusted yes
     IdentityFile ~/.ssh/id_second-chance_rsa
     User dustfinger</code></pre></div>
<p>I commented out <code>ForwardX11Trusted yes</code> on purpose. Only set <code>ForwardX11Trusted yes</code> if you fully trust the server, i.e. your PinePhone. You may choose to leave that option commented out and instead pass <code>-Y</code> optional flag only when you require x-forwarding and untrusted X11 forwarding fails. For the purposes of this post I have uncommented that option for my own convenience.</p>

<p>Copy ssh id to remote authorized keys (see <a href="https://linux.die.net/man/1/ssh-copy-id">ssh-copy-id(1)</a>).</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh-copy-id -i ~/.ssh/id_second-chance_rsa.pub dustfinger@second-chance</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &#34;/home/dustfinger/.ssh/id_second-chance_rsa.pub&#34;
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
dustfinger@second-chance&#39;s password:

Number of key(s) added: 1

Now try logging into the machine, with:   &#34;ssh &#39;dustfinger@second-chance&#39;&#34;
and check to make sure that only the key(s) you wanted were added.</code></pre></div>
<p>As long as you don&rsquo;t see any warnings, such as <em>Warning: untrusted X11 forwarding setup failed: xauth key data not generated</em>, your <em>SSH</em> requests should have access to the display. You can test this by running seeing if the <code>$DISPLAY</code> variable is set.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh dustfinger@second-chance <span style="color:#ed9d13">&#39;echo $DISPLAY&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">localhost:10.0</code></pre></div>
<h2 id="set-a-theme">Set a theme</h2>

<p>Early in my career, I spent many long days staring at CRT monitors. CRT monitors flicker each time the screen refreshes. Over time, the constant flickering began to affect my vision. Eventually, the whole world seemed to flicker. I found that dark themed applications reduced the effect that the flickering was having on my eyes. After that experience, I have been using dark themes whenever possible to reduce the amount of light that my eyes are subjected to on a daily basis. Modern flat screen monitors do not have a noticeable flicker. I now prefer dark themes for their aesthetic and light reducing affect. To enable a dark theme on Plasma Mobile:</p>

<ol>
<li><p>Navigate to <em>Settings</em> and select <em>Appearance</em></p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/plasma-settings-appearance-selected.png"/> 
</figure>
</li>

<li><p>select <em>Breeze Dark</em>, or whatever suits you</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/plasma-settings-appearance-breeze-dark.png"/> 
</figure>
</li>
</ol>

<p>I quite like Oxygen as well:</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/plasma-settings-appearance-oxygen.png"/> 
</figure>


<h2 id="how-to-take-a-screen-shot">How to take a screen shot</h2>

<p>You might be wondering how I was able to take those screen shots when <a href="#set-a-theme">setting a theme</a>. The <em>quick settings tray</em> contains a screen shot action item. To invoke it, swipe downwards from the top of the display and touch the icon labelled <em>Screenshot</em>.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/plasma-mobile-quick-settings-tray.png"/> 
</figure>


<p>Unfortunately, the screen shot action item only captures a portion of the display. This will be fixed in a future update, but in the meantime I wanted another solution. I wanted to be able to take screen shots from a serial or SSH connection. The postmarketOS Plasma Mobile wiki page has a section on <a href="https://wiki.postmarketos.org/wiki/Plasma%5FMobile#Taking%5Fscreenshots">taking screenshots</a> using <code>qdbus</code>. That sounded perfect to me. Their example uses the <code>org.kde.KWin</code> DBus service, but unfortunately <code>qdbus</code> couldn&rsquo;t find it on the session bus. In fact, I didn&rsquo;t have access to a session bus at all.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus org.kde.KWin</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Could not connect to D-Bus server: org.freedesktop.DBus.Error.NotSupported: Unable to autolaunch a dbus-daemon without a $DISPLAY for X11</code></pre></div>
<p>Looking above the <em>Taking screenshots</em> heading, I noticed a section on <a href="https://wiki.postmarketos.org/wiki/Plasma%5FMobile#Running%5FApps%5Ffrom%5FSSH%5Fsession">running apps from an SSH session</a> where they recommend exporting all of the environment variables available to the <code>plasmashell</code> process. After researching this a bit further, I discovered that having <a href="https://docs.plasma-mobile.org/RunningApps.html">an environment setup similar to plasmashell is necessary for running many applications</a>. So I decided to try it out.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ <span style="color:#24909d">export</span> <span style="color:#6ab825;font-weight:bold">$(</span>cat /proc/<span style="color:#ed9d13">`</span>pidof plasmashell<span style="color:#ed9d13">`</span>/environ | tr <span style="color:#ed9d13">&#39;\0&#39;</span> <span style="color:#ed9d13">&#39;\n&#39;</span><span style="color:#6ab825;font-weight:bold">)</span></code></pre></div>
<p>Unfortunately, the first time I tried to take a screen shot using <code>org.kde.kwin.Screenshot.screenshotArea</code> the request timed out waiting for a response.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~<span style="color:#40ffff">$qdbus</span> org.kde.KWin /Screenshot org.kde.kwin.Screenshot.screenshotArea <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">1440</span> <span style="color:#3677a9">720</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Error: org.freedesktop.DBus.Error.NoReply
Did not receive a reply. Possible causes include: the remote application did not send a reply, the message bus security policy blocked the reply, the reply timeout expired, or the network connection was broken</code></pre></div>
<p>Subsequent attempts at taking a screenshot would result in an error complaining that one was already being taken.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~<span style="color:#40ffff">$qdbus</span> org.kde.KWin /Screenshot org.kde.kwin.Screenshot.screenshotArea <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">1440</span> <span style="color:#3677a9">720</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Error: org.kde.kwin.Screenshot.Error.AlreadyTaking
A screenshot is already been taken</code></pre></div>
<p>I am sure that there is a way to recover gracefully from that state, but I simply rebooted. How then was I able to take screen shots you ask? By exporting only the <code>DBUS_SESSION_BUS_ADDRESS</code> from the <code>plasmashell</code> environment, I gained access to that session bus.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ <span style="color:#24909d">export</span> <span style="color:#6ab825;font-weight:bold">$(</span>cat /proc/<span style="color:#ed9d13">`</span>pidof plasmashell<span style="color:#ed9d13">`</span>/environ | tr <span style="color:#ed9d13">&#39;\0&#39;</span> <span style="color:#ed9d13">&#39;\n&#39;</span> | grep -i dbus_session_bus_address<span style="color:#6ab825;font-weight:bold">)</span>
second-chance:~$ qdbus</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">:1.1
 org.freedesktop.ScreenSaver
 org.kde.KWin
 org.kde.kglobalaccel
 org.kde.screensaver
:1.10
 org.kde.GtkConfig
 org.kde.StatusNotifierWatcher
 org.kde.kappmenu
 org.kde.kcookiejar5
 org.kde.kded5
 org.kde.kscreen.osdService
 org.kde.plasmanetworkmanagement
:1.11
 org.kde.ksmserver
:1.12
 org.kde.baloo
:1.13
:1.14
:1.15
 org.freedesktop.Notifications
 org.kde.JobViewServer
 org.kde.StatusNotifierHost-2905
 org.kde.kuiserver
 org.kde.plasmashell
:1.16
 org.kde.calindac
:1.17
 org.kde.polkit-kde-authentication-agent-1
:1.18
 local.org_kde_powerdevil
 org.freedesktop.PowerManagement
 org.freedesktop.PowerManagement.Inhibit
 org.kde.Solid.PowerManagement
 org.kde.Solid.PowerManagement.PolicyAgent
:1.19
 org.kde.ActivityManager
:1.20
 org.PulseAudio1
 org.pulseaudio.Server
:1.3
:1.31
:1.35
:1.36
:1.6
:1.8
 org.kde.klauncher5
org.freedesktop.DBus</code></pre></div>
<p>Then I simply called the <code>org.kde.kwin.Screenshot.interactive</code> method, as opposed to <code>org.kde.kwin.Screenshot.screenshotArea</code>, which prompted me to select the window that I would like to take a screen shot of.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus org.kde.KWin /Screenshot org.kde.kwin.Screenshot.interactive</code></pre></div>
<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/plasma-mobile-desktop-without-header-and-footer.png"/> 
</figure>


<p>In this example I simply touched the desktop. Since the desktop window is separate from both the header and footer, the resulting image does not include features such as mobile signal strength and the current time. If you figure out how to take a full screen capture please comment and let us know the details. I have also tried <code>org.kde.kwin.Screenshot.screenshotFullscreen</code>, but at the time of this writing that only captured a portion of the display.</p>

<h2 id="audio-configuration">Audio configuration</h2>

<p>The <em>ALSA</em> (<a href="https://en.wikipedia.org/wiki/Advanced%5FLinux%5FSound%5FArchitecture">Advanced Linux Sound Architecture</a>) package can be installed to provide sound support for postmarketOS. The package includes a large number of drivers and various tools, such as the venerable <a href="https://en.wikipedia.org/wiki/Alsamixer">alsamixer</a>. To learn more about ALSA, checkout the <a href="https://alsa-project.org">ALSA project homepage</a>. Also, be sure to check out the <a href="https://alsa.opensrc.org/">Independent ALSA and Linux audio support site</a>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo apk add alsa-utils</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(1/4) Installing dialog (1.3.20200327-r0)
(2/4) Installing fftw-single-libs (3.3.8-r0)
(3/4) Installing alsa-utils (1.2.2-r0)
(4/4) Installing alsa-utils-openrc (1.2.2-r0)
Executing busybox-1.31.1-r14.trigger
Executing eudev-3.2.9-r3.trigger
Executing postmarketos-base-3-r33.trigger
Configuring a getty on port ttyS0 with baud rate 115200
OK: 1697 MiB in 578 packages</code></pre></div>
<p>Inspect which groups both <code>root</code> and your user belong to.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ groups</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">dustfinger wheel audio input video netdev plugdev</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ groups root</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">root bin daemon sys adm disk wheel floppy dialout tape video</code></pre></div>
<p>Both of these users should be a member of the <code>audio</code> group.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo usermod -aG audio <span style="color:#40ffff">$USER</span>
second-chance:~$ sudo usermod -aG audio root</code></pre></div>
<p>Start the <code>alsa</code> daemon.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service alsa start</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[sudo] password for dustfinger:
 * Restoring Mixer Levels ...
 * No mixer config in /var/lib/alsa/asound.state, you have to unmute your card!
 [ ok ]</code></pre></div>
<p>From the output above it looks like we have to unmute the <em>Master</em> simple control. Once we have done that, we will be able to use the PinePhone&rsquo;s volume button to adjust the volume. However, I thought I would quickly cover the basics of how to use <code>amixer</code> since we are touching on it anyway. For more information on usage, see the <a href="https://alsa.opensrc.org/Amixer">Amixer wiki page</a>.</p>

<p>To display general mixer information use the <code>amixer info</code> sub command.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ amixer info</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Card default &#39;pulse&#39;/&#39;PulseAudio&#39;
  Mixer name    : &#39;PulseAudio&#39;
  Components    : &#39;&#39;
  Controls      : 4
  Simple ctrls  : 2</code></pre></div>
<p>You can see that there are 2 simple controls and 4 not-so-simple controls :-P. If you would like to know the complete list of valid simple control names that can be used with the <code>sset</code> and <code>sget</code> subcommand, simply run <code>amixer scontrols</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ amixer scontrols</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Simple mixer control &#39;Master&#39;,0
Simple mixer control &#39;Capture&#39;,0</code></pre></div>
<p>To display the complete list of valid control identifiers that can be used with the <code>cset</code> and <code>cget</code> subcommands, run <code>amixer controls</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ amixer controls</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">numid=4,iface=MIXER,name=&#39;Master Playback Switch&#39;
numid=3,iface=MIXER,name=&#39;Master Playback Volume&#39;
numid=2,iface=MIXER,name=&#39;Capture Switch&#39;
numid=1,iface=MIXER,name=&#39;Capture Volume&#39;</code></pre></div>
<p>For example, if we wanted to use <code>cget</code> to display information about the <em>Master Playback Volume</em>, we can pass it the key <em>name</em> and the value <em>&lsquo;Master Playback Volume&rsquo;</em></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ amixer cget <span style="color:#40ffff">name</span>=<span style="color:#ed9d13">&#39;Master Playback Volume&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">numid=3,iface=MIXER,name=&#39;Master Playback Volume&#39;
  ; type=INTEGER,access=rw------,values=2,min=0,max=65536,step=1
  : values=58982,58982</code></pre></div>
<p>To display an overview of the configuration, use the <code>amixser scontents</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ amixer scontents</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Simple mixer control &#39;Master&#39;,0
  Capabilities: pvolume pswitch pswitch-joined
  Playback channels: Front Left - Front Right
  Limits: Playback 0 - 65536
  Mono:
  Front Left: Playback 58982 [90%] [off]
  Front Right: Playback 58982 [90%] [off]
Simple mixer control &#39;Capture&#39;,0
  Capabilities: cvolume cswitch cswitch-joined
  Capture channels: Front Left - Front Right
  Limits: Capture 0 - 65536
  Front Left: Capture 65536 [100%] [on]
  Front Right: Capture 65536 [100%] [on]</code></pre></div>
<p>In the above output, you might notice that the <em>Master</em> control is indicated as being <em>off</em>. When you see <em>[off]</em> that means it is muted. Your master control was probably unmuted automatically when you started the alsa daemon, but I will show you how to unmute the master control just in case. To turn the <em>Master</em> control on, simply unmute it with the following command:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ amixer sset Master unmute</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Simple mixer control &#39;Master&#39;,0
  Capabilities: pvolume pswitch pswitch-joined
  Playback channels: Front Left - Front Right
  Limits: Playback 0 - 65536
  Mono:
  Front Left: Playback 58982 [90%] [on]
  Front Right: Playback 58982 [90%] [on]</code></pre></div>
<p>Try playing with the PinePhone&rsquo;s volume control to increase or decrease the volume, then output the configuration again and observe that the volume percentage has changed accordingly.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ amixer scontents</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Simple mixer control &#39;Master&#39;,0
  Capabilities: pvolume pswitch pswitch-joined
  Playback channels: Front Left - Front Right
  Limits: Playback 0 - 65536
  Mono:
  Front Left: Playback 36043 [55%] [on]
  Front Right: Playback 36043 [55%] [on]
Simple mixer control &#39;Capture&#39;,0
  Capabilities: cvolume cswitch cswitch-joined
  Capture channels: Front Left - Front Right
  Limits: Capture 0 - 65536
  Front Left: Capture 65536 [100%] [on]
  Front Right: Capture 65536 [100%] [on]</code></pre></div>
<p>From the output above we can see that my volume is now at 55%. To test the sound we can run the <code>speaker-test</code> command. The <code>-l</code> optional parameter controls the number of loops. See <a href="https://linux.die.net/man/1/speaker-test">speaker-test(1)</a> for more information.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ speaker-test -c2 -l <span style="color:#3677a9">1</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">speaker-test 1.2.2

Playback device is default
Stream parameters are 48000Hz, S16_LE, 2 channels
Using 16 octaves of pink noise
Rate set to 48000Hz (requested 48000Hz)
Buffer size range from 96 to 1048576
Period size range from 32 to 349526
Using max buffer size 1048576
Periods = 4
was set period_size = 262144
was set buffer_size = 1048576
 0 - Front Left
 1 - Front Right
Time per period = 11.079789</code></pre></div>
<p>Alsa configuration paths. Take the time to become familiar with the configuration files:</p>

<ul>
<li><code>/etc/conf.d/alsa</code></li>
<li><code>/usr/share/alsa/</code></li>
<li><code>/etc/alsa/conf.d/</code></li>
<li><code>/usr/share/pulseaudio/alsa-mixer/</code></li>
</ul>

<p>Finally, add the alsa daemon to the default runlevel so that it starts automatically the next time we boot the phone.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-update add alsa default</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* service alsa added to runlevel default</code></pre></div>
<h2 id="dbus-basics">DBus Basics</h2>

<p><em>DBus</em> is a service for <em>Inter-Process Communication</em> (IPC). When a service registers itself with DBus, it publishes an interface to facilitate interoperabillity with other processes. The oFono daemon is one such service. We will be using DBus to get information about our modem and configuration from the oFono daemon. Many frameworks wrap the low <a href="https://gitlab.freedesktop.org/dbus/dbus/-/blob/master/doc/busconfig.dtd">level libdbus XML bindings</a> providing <a href="https://www.freedesktop.org/wiki/Software/DBusBindings/">higher level bindings</a> for their own API. High-level Interface bindings use appropriate programming language constructs, meaning that bindings for Java based services would normally expose a Java interface and Python based services would normally expose a Python interface etc.</p>

<p>I am going to show you how to find your way around dbus from the CLI. In the next two sections I will show you how to install and use <a href="#qt-dbus-viewer">Qt DBus Viewer</a> and <a href="#gnome-d-feet-d-bus-debugger">GNOME D-Feet D-Bus Debugger</a> to do the same thing with a UI.</p>

<p>In order to send a message to a service that is registered with DBus, we first need to know its name. Thankfully, DBus registers its own service named <code>org.freedesktop.DBus</code> that exposes the method <code>org.freedesktop.DBus.ListNames</code> for just this purpose. We can call it using the <code>dbus-send</code> command on any system running dbus like this:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ dbus-send --system --print-reply --dest=org.freedesktop.DBus /org/freedesktop/DBus org.freedesktop.DBus.ListNames</code></pre></div>
<p>There are many ways to do the same thing. Plasma Mobile comes with <a href="https://www.qt.io/">Qt</a> which includes <code>qdbus</code> (see <a href="https://www.commandlinux.com/man-page/man1/qdbus.1.html">qdbus(1)</a>) and provides shorter commands. Yet another option is <code>gdbus</code> (see <a href="https://www.commandlinux.com/man-page/man1/gdbus.1.html">gdbus(1)</a>) which comes with <a href="https://wiki.gnome.org/Projects/GLib">GLib</a>. One advantage of <code>gdbus</code> is bash completion. It would have been my first choice, save for the fact that my login shell is the Almquist Shell and it does not appear to support completion for <code>gdbus</code>. In general bash completion seems to work. Maybe I need to configure <code>gdbus</code>, or install another package, to get that spport in this environment. If you know the answer, please comment. At any rate, I am going to stick with <code>qdbus</code> for the remainder of this post for simplicity.</p>

<p>The following <code>qdbus</code> command is equivalent:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">:1.0
 fi.w1.wpa_supplicant1
:1.1
 org.freedesktop.NetworkManager
:1.11
 org.freedesktop.URfkill
:1.112
:1.113
:1.12
:1.13
:1.14
:1.15
:1.16
 org.freedesktop.UPower
:1.165
:1.17
:1.18
:1.19
:1.20
:1.27
:1.28
:1.29
:1.3
 org.freedesktop.DisplayManager
:1.30
:1.4
:1.5
 org.ofono
:1.6
 org.freedesktop.login1
:1.7
 org.freedesktop.Accounts
:1.8
 org.freedesktop.PolicyKit1
:1.9
org.freedesktop.DBus</code></pre></div>
<p>To get a list of object paths that are exposed by the <code>org.ofono</code> service we can call:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/
/bluetooth
/bluetooth/profile
/bluetooth/profile/dun_gw
/bluetooth/profile/hfp_ag
/bluetooth/profile/hfp_hf
/quectelqmi_0
/quectelqmi_0/context1
/quectelqmi_0/operator
/quectelqmi_0/operator/&lt;REDACTED&gt;</code></pre></div>
<p>An object path contains methods and signals. To list only the methods exposed by the object <code>/quectelqmi_0/context1</code>, we can use <code>grep</code> to filter the result.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono /quectelqmi_0/context1 | grep -i method</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">method QString org.freedesktop.DBus.Introspectable.Introspect()
method QVariantMap org.ofono.ConnectionContext.GetProperties()
method void org.ofono.ConnectionContext.SetProperty(QString property, QDBusVariant value)</code></pre></div>
<p>The <code>qdbus</code> CLI uses the <a href="https://doc.qt.io/qt-5/qtdbus-index.html">Qt API</a> bindings which is why we are seeing types such as <code>QString</code> or <code>QBusVariant</code> from the <a href="https://doc.qt.io/qt-5/qdbustypesystem.html">Qt D-Bus type system</a>. If we do the same thing with <code>dbus-send</code>, then we will see <a href="https://developer.gnome.org/glib/stable/glib-GVariantType.html">GVariant types</a> being used from the <a href="https://developer.gnome.org/gio/stable/gdbus-lowlevel.html">low-level DBus bindings</a> instead.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono /quectelqmi_0/context1 org.freedesktop.DBus.Introspectable.Introspect | grep -i method</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#6ab825;font-weight:bold">&lt;node&gt;&lt;interface</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;org.freedesktop.DBus.Introspectable&#34;</span><span style="color:#6ab825;font-weight:bold">&gt;&lt;method</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;Introspect&#34;</span><span style="color:#6ab825;font-weight:bold">&gt;&lt;arg</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;xml&#34;</span> <span style="color:#bbb">type=</span><span style="color:#ed9d13">&#34;s&#34;</span> <span style="color:#bbb">direction=</span><span style="color:#ed9d13">&#34;out&#34;</span><span style="color:#6ab825;font-weight:bold">/&gt;</span>
<span style="color:#6ab825;font-weight:bold">&lt;/method&gt;&lt;/interface&gt;&lt;interface</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;org.ofono.ConnectionContext&#34;</span><span style="color:#6ab825;font-weight:bold">&gt;&lt;method</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;GetProperties&#34;</span><span style="color:#6ab825;font-weight:bold">&gt;&lt;arg</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;properties&#34;</span> <span style="color:#bbb">type=</span><span style="color:#ed9d13">&#34;a{sv}&#34;</span> <span style="color:#bbb">direction=</span><span style="color:#ed9d13">&#34;out&#34;</span><span style="color:#6ab825;font-weight:bold">/&gt;</span>
<span style="color:#6ab825;font-weight:bold">&lt;/method&gt;&lt;method</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;SetProperty&#34;</span><span style="color:#6ab825;font-weight:bold">&gt;&lt;arg</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;property&#34;</span> <span style="color:#bbb">type=</span><span style="color:#ed9d13">&#34;s&#34;</span> <span style="color:#bbb">direction=</span><span style="color:#ed9d13">&#34;in&#34;</span><span style="color:#6ab825;font-weight:bold">/&gt;</span>
<span style="color:#6ab825;font-weight:bold">&lt;/method&gt;&lt;signal</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;PropertyChanged&#34;</span><span style="color:#6ab825;font-weight:bold">&gt;&lt;arg</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#34;name&#34;</span> <span style="color:#bbb">type=</span><span style="color:#ed9d13">&#34;s&#34;</span><span style="color:#6ab825;font-weight:bold">/&gt;</span></code></pre></div>
<p>That should give you an idea of how to get information. Careful not to get your APIs crossed.</p>

<h3 id="qt-dbus-viewer">Qt DBus Viewer</h3>

<p>The <em>Qt DBus Viewer</em> is a reasonable choice since PlasmaMobile already uses <em>Qt</em>. The UI is partially touch friendly, but the layout is not responsive enough to be considered practicable while rendered in portrait view.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/qtdbusviewer-with-ofono-manager-get-modems-selected-mobile.png"/> 
</figure>


<p>At the time of writing Plasma Mobile&rsquo;s screen rotation is not working, without some investigation it is not clear how to switch from portrait to landscape. Scrolling is also an issue since it requires that you touch and drag the narrow scroll bar with your wide fingers. If you attempt to touch and drag a window pane, you will select a region of text instead. If you choose to install Qt D-Bus Viewer, then I recommend that you <a href="#configure-x-forwarding">configure x-forwarding</a> and forward the display to your desktop where the user experience will be as intended.</p>

<p>You might already think that you have <code>qdbusviewer</code> installed because the command is in the <code>$PATH</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ which qdbusviewer</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/usr/bin/qdbusviewer</code></pre></div>
<p>However, if you execute the command, it will become clear that it is missing at least one implementation binary.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbusviewer</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">qdbusviewer: could not exec &#39;/usr/lib/qt5/bin/qdbusviewer&#39;: No such file or directory</code></pre></div>
<p>You can install <code>qdbusviewer</code> by running the following command.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo apk add qt5-qdbusviewer</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[sudo] password for dustfinger:
fetch http://postmarketos1.brixit.nl/postmarketos/master/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/main/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/community/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/testing/aarch64/APKINDEX.tar.gz
(1/1) Installing qt5-qdbusviewer (5.14.2-r0)
Executing busybox-1.31.1-r16.trigger
Executing gtk-update-icon-cache-2.24.32-r1.trigger
OK: 1358 MiB in 597 packages</code></pre></div>
<p>Qt package information:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ apk info --description --webpage --size --depends --provides --license qt5-qdbusviewer</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">qt5-qdbusviewer-5.14.2-r0 description:
D-Bus debugger and viewer

qt5-qdbusviewer-5.14.2-r0 webpage:
https://www.qt.io/developers/

qt5-qdbusviewer-5.14.2-r0 installed size:
208896

qt5-qdbusviewer-5.14.2-r0 depends on:
so:libQt5Core.so.5
so:libQt5DBus.so.5
so:libQt5Gui.so.5
so:libQt5Widgets.so.5
so:libQt5Xml.so.5
so:libc.musl-aarch64.so.1
so:libstdc++.so.6

qt5-qdbusviewer-5.14.2-r0 provides:
cmd:qdbusviewer-qt5

qt5-qdbusviewer-5.14.2-r0 license:
(LGPL-2.0-or-later OR GPL-3.0-only OR GPL-2.0-or-later) AND Qt-GPL-exception-1.0 AND GFDL-1.3-or-later</code></pre></div>
<p>Once you have x-forwarding configured, you will be able to render the Qt D-Bus instance that is running on your phone on your computer&rsquo;s monitor:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">dustfinger@galactica ~/ $ ssh second-chance qdbusviewer</code></pre></div>
<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/qtdbusviewer-with-ofono-radio-settings-get-properties-selected-x-forwarding.png"/> 
</figure>


<p>The tool is dead simple. Use the tab to switch between <em>Session</em> and <em>System Bus</em>. Services which are registered with DBus are listed by name in the left pane. Selecting a service will cause Qt D-Bus Viewer to display a list of root level interfaces or object paths depending on what the service exposes. Root level interfaces are actually defined in the object path <code>/</code>, but the UI omits that object path for convenience. Expanding an object path will reveal its interface in a tree-view. To execute a method, simply double click it.</p>

<p>Take a moment to play around with it. Don&rsquo;t forget to visit the <a href="https://doc.qt.io/qt-5/qtdbus-index.html">Qt D-Bus documentation</a> and keep the <a href="https://doc.qt.io/qt-5/qdbustypesystem.html">Qt D-Bus type system</a> handy for reference.</p>

<h3 id="gnome-d-feet-d-bus-debugger">GNOME D-Feet D-Bus Debugger</h3>

<p>D-Feet is buggy when operated from the PinePhone touch display. Although you can scroll by touch-dragging a window pane, the UI frequently stops responding after selecting a bus name. Since, in my case at least, it is not practicable from the touch interface, I recommend that you <a href="#configure-x-forwarding">configure x-forwarding</a> and interact with d-feet from your computer.</p>

<p>To illustrate my experience I took a screen capture after I managed to call <code>getProperties</code> from the <code>Sim Manager</code>:
<img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/d-feet-with-ofono-quectelqmi-sim-manager-interface-get-properties-method-selected-mobile.png" alt="" /></p>

<p>I then selected another bus name which caused the UI to stop responding at the moment that both bus names were highlighted.
<img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/d-feet-with-ofono-quectelqmi-sim-manager-service-and-freedesktop-login-service-selected-ui-unresponsive-mobile.png" alt="" /></p>

<p>I discovered that swiping down to reveal the <em>quick settings tray</em> often, but not always, causes D-Feet UI to become responsive again. So if you are experimenting with D-Feet from the touch screen of your phone and the UI locks up, you could try swiping down to get it to respond. Failing that, there is always <code>SIGINT</code>, i.e. <code>kill -2 `pidof d-feet`</code>.</p>

<p>To install dFeet run the following command:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo apk add d-feet</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">fetch http://postmarketos1.brixit.nl/postmarketos/master/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/main/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/community/aarch64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/testing/aarch64/APKINDEX.tar.gz
(1/3) Installing gobject-introspection (1.64.1-r2)
(2/3) Installing py3-gobject3 (3.36.1-r0)
(3/3) Installing d-feet (0.3.15-r2)
Executing busybox-1.31.1-r16.trigger
Executing glib-2.64.3-r0.trigger
Executing gtk-update-icon-cache-2.24.32-r1.trigger
OK: 1356 MiB in 594 packages</code></pre></div>
<p>Make sure that <code>sshd</code> is running:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service sshd status</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* status: stopped</code></pre></div>
<p>Start the daemon if it is not running:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service sshd start</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* Starting sshd ...
[ ok ]</code></pre></div>
<p>From your home computer launch <code>d-feet</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">dustfinger@galactica ~/ $ ssh second-chance d-feet</code></pre></div>
<p>Just like <a href="#qt-dbus-viewer">Qt DBus Viewer</a>, D-Feet is dead simple to use. Services which are registered with DBus are listed by name in the left pane. Selecting a service will cause D-Feet to display that service&rsquo;s <em>address</em>, <em>name</em>, <em>unique name</em> and <em>object path</em> in the right pane. Expanding an object path will reveal its interface in a tree-view. To execute a method, simply double click it.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/d-feet-with-ofono-quectelqmi-sim-manager-interface-get-properties-method-selected.png"/> 
</figure>


<p>Take a moment and play aroud with D-Feet via x-forwarding and don&rsquo;t forget to visit the <a href="https://wiki.gnome.org/Apps/DFeet">Gnome wiki D-Feet documentation</a>. I also recommend that you keep this reference on <a href="https://developer.gnome.org/glib/stable/glib-GVariantType.html">GVariant types</a> and the <a href="https://developer.gnome.org/gio/stable/gdbus-convenience.html">GLib APIs</a> handy.</p>

<h2 id="configure-the-modem">Configure the modem</h2>

<p>In the subsections to follow we are going to be configuring our modem, which will involve connecting to the modem over a serial port and running a number of <em>AT commands</em> (<a href="https://en.wikipedia.org/wiki/Hayes%5Fcommand%5Fset#Description">Attention commands</a>). Recent versions of postmarketOS now handle this configuration for you; however, if you have difficulty configuring your APN settings or making a phone call it can be helpful to understand how to validate the modem&rsquo;s configuration when trouble shooting.</p>

<p>There are many tools available that will allow you to connect to a modem; I have decided to use <code>minicom</code>. I will also be showing you how to run AT commands directly from the command line. Regardless of how you choose to send AT commands to the modem there are two pre-requisites that must be satisfied.</p>

<ol>
<li>We need to know the <em>special file name</em> of the <em>serial port</em></li>
<li>Our user must have <em>read</em> and <em>write</em> permissions to the special file name of the serial port</li>
</ol>

<h3 id="identify-the-serial-port">Identify the serial port</h3>

<p>The output from <code>dmesg</code> can be used to determine which serial ports the modem is attached to.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ dmesg | grep -i modem</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[   80.291634] usbserial: USB Serial support registered for GSM modem (1-port)
[   80.292045] option 3-1:1.0: GSM modem (1-port) converter detected
[   80.294623] usb 3-1: GSM modem (1-port) converter now attached to ttyUSB0
[   80.294965] option 3-1:1.1: GSM modem (1-port) converter detected
[   80.298683] usb 3-1: GSM modem (1-port) converter now attached to ttyUSB1
[   80.298975] option 3-1:1.2: GSM modem (1-port) converter detected
[   80.301833] usb 3-1: GSM modem (1-port) converter now attached to ttyUSB2
[   80.310246] option 3-1:1.3: GSM modem (1-port) converter detected
[   80.310645] usb 3-1: GSM modem (1-port) converter now attached to ttyUSB3</code></pre></div>
<p>In the above output, we can see that USB serial support was registered for a <em>GSM</em> modem. The modem is connected to the PinePhone via a USB converter. Whenever a USB converter is attached to a serial device you will see the text <em><code>converter now attached to &lt;SPECIAL FILE NAME&gt;</code></em> in the output of <code>dmesg</code>.</p>

<p>Now that we have the names of the serial ports, we can determine the group ownership of the special file names via the <code>ls</code> command.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ls -lah /dev/ttyUSB*</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">crw-rw----    1 root     dialout   188,   0 May 16 05:08 /dev/ttyUSB0
crw-rw----    1 root     dialout   188,   1 May 16 05:08 /dev/ttyUSB1
crw-rw----    1 root     dialout   188,   2 May 16 05:08 /dev/ttyUSB2
crw-rw----    1 root     dialout   188,   3 May 16 05:08 /dev/ttyUSB3</code></pre></div>
<p>The <em>dialout</em> group is the typical application group for modems, but it is always worth confirming the actual group name by looking it up yourself. After all, it is always possible that group ownership was not set correctly, or that a different application group was used for this purpose.</p>

<p>We can use the <code>groups</code> command to find out if our user is already a member of <em>dialout</em>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ groups <span style="color:#40ffff">$USER</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">dustfinger wheel audio input video netdev plugdev</code></pre></div>
<p>In my case, <em>dustfinger</em> is not a member of the <em>dialout</em> group. I will add <em>dustfinger</em> to the <em>dialout</em> group using <code>gpasswd</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo gpasswd -a <span style="color:#40ffff">$USER</span> dialout</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[sudo] password for dustfinger:
Adding user dustfinger to group dialout</code></pre></div>
<p>You might be wondering how we know which of the four serial ports to connect to. Thankfully postmarketOS created descriptive symlinks to each of these ports. We can use the <code>find</code> command to locate those symlinks:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ find /dev -maxdepth <span style="color:#3677a9">1</span> -type l -exec ls -la <span style="color:#ed9d13">&#39;{}&#39;</span> <span style="color:#ed9d13">\;</span> | grep ttyUSB</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">lrwxrwxrwx    1 root     root             7 Jun  4 05:09 /dev/EG25.MODEM -&gt; ttyUSB3
lrwxrwxrwx    1 root     root             7 Jun  4 05:09 /dev/EG25.AT -&gt; ttyUSB2
lrwxrwxrwx    1 root     root             7 Jun  4 05:09 /dev/EG25.NMEA -&gt; ttyUSB1</code></pre></div>
<p>It should be obvious that when establishing an interactive session with the modem using a tool like <code>minicom</code> the correct port is the one with the alias <code>EG25.MODEM</code>. In fact, we can simply use the alias if we prefer.</p>

<h3 id="enable-ofono-debug-logging">Enable oFono debug logging</h3>

<p>There are two debugging features that you can enable to gain some insight when trouble shooting issues with your modem or SIM configuration. To enable them, I found it easiest to create the following config file for <code>ofonod</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo vi /etc/conf.d/ofono</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># optional parameters to be passed to ofonod. See ofonod --help
OFONOD_OPTS=&#34;-d&#34;

# enable or disable AT debugging
ENABLE_AT_DEBUGGING=true</code></pre></div>
<p>Next, I modified <code>/etc/init.d/ofono</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo vi /etc/init.d/ofono</code></pre></div>
<p>and added a <code>start_pre</code> function to conditionally export the AT debug environment variable based on the value of <code>$ENABLE_AT_DEBUGGING</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">start_pre() {
        <span style="color:#999;font-style:italic"># enable / disable AT debugging</span>
        <span style="color:#6ab825;font-weight:bold">if</span> [ -n <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$ENABLE_AT_DEBUGGING</span><span style="color:#ed9d13">&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
                <span style="color:#6ab825;font-weight:bold">if</span> yesno <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$ENABLE_AT_DEBUGGING</span><span style="color:#ed9d13">&#34;</span>; <span style="color:#6ab825;font-weight:bold">then</span>
                        einfo <span style="color:#ed9d13">&#34;AT debugging is enabled by config&#34;</span>
                        <span style="color:#24909d">export</span> <span style="color:#40ffff">OFONO_AT_DEBUG</span>=<span style="color:#3677a9">1</span>
                <span style="color:#6ab825;font-weight:bold">else</span>
                        einfo <span style="color:#ed9d13">&#34;AT debugging is disabled by config&#34;</span>
                        <span style="color:#24909d">export</span> <span style="color:#40ffff">OFONO_AT_DEBUG</span>=<span style="color:#3677a9">0</span>
                <span style="color:#6ab825;font-weight:bold">fi</span>
        <span style="color:#6ab825;font-weight:bold">fi</span>

        einfo <span style="color:#ed9d13">&#34;command_args_foreground = </span><span style="color:#40ffff">$command_args_foreground</span><span style="color:#ed9d13">&#34;</span>
}</code></pre></div>
<p>I also added <code>$OFONOD_OPTS</code> to the <code>command_args_forground</code> assignment.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#40ffff">command_args_foreground</span>=<span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$OFONOD_OPTS</span><span style="color:#ed9d13"> -n&#34;</span></code></pre></div>
<p>Now restart the oFono service and you should see the following output:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service ofono restart</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* Caching service dependencies ...                                       [ ok ]
* Stopping oFono ...                                                     [ ok ]
* AT debugging is enabled by config
* command_args_foreground = -d -n
* Starting oFono ...                                                     [ ok ]</code></pre></div>
<p>You probably don&rsquo;t want to leave all that debugging enabled permanently, so don&rsquo;t forget to disable it once you are happy with your configuration.</p>

<h3 id="connect-to-the-modem">Connect to the modem</h3>

<p>You may skip this step if you would prefer to <a href="#send-an-at-command-from-the-shell">send the AT commands directly from the shell</a>.</p>

<p>The <em><a href="https://bloggerbust.ca/page/appendix/#line-speed">line speed</a></em> for the <a href="http://files.pine64.org/doc/datasheet/pinephone/Quectel%5FEG25-G%5FLTE%5FSpecification%5FV1.0.pdf">Quectel EG25</a> is 1152008n1 which is the default line speed for <code>minicom</code>. The only thing we need to tell <code>minicom</code> is the port.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">minicom -D /dev/ttyUSB2</code></pre></div>
<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/minicom-welcome-screen.png"/> 
</figure>


<h3 id="at-command-basics">AT Command Basics</h3>

<p>Please refer to the <a href="https://wiki.pine64.org/images/2/2e/Quectel%5FEC25EC21%5FAT%5FCommands%5FManual%5FV1.2.pdf">Quectel EC25 AT commands manual</a> when following along. There is an appendix on page 192 with many useful tables, such as terms &amp; abbreviations and error codes.</p>

<p>There are three categories of AT commands supported by the Quectel EC25.</p>

<ol>
<li>Basic Syntax :: <code>AT&lt;x&gt;&lt;n&gt;</code> where <code>&lt;x&gt;</code> is the command and <code>&lt;n&gt;</code> represents 0 or more arguments</li>
<li>S parameter syntax :: <code>ATS&lt;n&gt;=&lt;m&gt;</code> where <code>&lt;n&gt;</code> is a register index and <code>&lt;m&gt;</code> is the value to assign</li>
<li>Extended syntax :: see table below</li>
</ol>

<table>
<thead>
<tr>
<th>Type</th>
<th>Syntax</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>Test</td>
<td>AT+<x>=?</td>
<td>returns list of parameters and value ranges accepted by the write command or internal processes</td>
</tr>

<tr>
<td>Read</td>
<td>AT+<x>?</td>
<td>Returns current parameter(s) value(s)</td>
</tr>

<tr>
<td>Write</td>
<td>AT+<x>=&lt;&hellip;&gt;</td>
<td>Set parameter(s) value(s)</td>
</tr>

<tr>
<td>Execute</td>
<td>AT+<x></td>
<td>Read non-variable parameters affected by internal processes in the UE</td>
</tr>
</tbody>
</table>

<p>When powering down the modem it is recommended that you call <code>AT+QPOWD</code>. See <em>1.6 Turn off Procedure</em> of the manual. You don&rsquo;t need to worry about this anymore though, because postmarketOS handles this in the <code>eg25</code> service. It does not actually call the AT command, but instead it powers off the GPIO pins. If you ever want to restart the module without rebooting your phone, you can simply call:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service eg25 restart</code></pre></div>
<h3 id="send-an-at-command-from-the-shell">Send an AT command from the shell</h3>

<p>Sending an AT command directly from the shell is straight forward and I recommend this approach. I chose to use <code>minicom</code> for demonstration purposes and for fun. The most basic AT command is named <code>AT</code> and simply returns <code>OK</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;AT&#34;</span> | atinout - /dev/EG25.AT -</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">AT


OK</code></pre></div>
<h3 id="configure-the-modem-for-audio">Configure the modem for audio</h3>

<p>It is no longer necessary to perform this step manually. PostmarketOS now has a service named <code>pinephone_setup-modem-audio</code> that calls <code>/usr/bin/pinephone_setup-modem-audio</code> which runs the <code>AT+QDAI</code> AT command for you. If you need to change your audio routing for some reason, then you will need to update that script or it will just reset the configuration on next reboot. You are welcome to read on for learning purposes, or <a href="#check-audio-mode">skip to the next section</a>.</p>

<p>It is time to <a href="https://xnux.eu/devices/feature/modem-pp.html#toc-setting-up-the-modem-for-voice-calling">configure the modem for audio</a> by running the Quectel Digital Audio Interface (QDAI) configuration write command defined on page 193 of the <em><a href="https://wiki.pine64.org/images/2/2e/Quectel%5FEC25EC21%5FAT%5FCommands%5FManual%5FV1.2.pdf">AT commands manual</a></em>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">AT+QDAI=<span style="color:#3677a9">1</span>,0,0,2,0,1,1,1</code></pre></div>
<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/minicom-configure-digital-audio-interface.png"/> 
</figure>


<p>The command only needs to be run one time since the configuration is persistent, but the effects will not be realized until the module is rebooted.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">This sets modem to:

  1 - Digital PCM
  0 - I2S master
  0 - Primary mode (short sync)
  1 - 256kHz clock (256kHz / 16bit = 16k samples/s)
  0 - 16bit linear format
  1 - 16kHz sample
  1 - 1 slot
  1 - map to first slot (the only slot)</code></pre></div>
<p>See page 194 of the AT commands manual for a full explanation of the parameters and their values.</p>

<h3 id="check-audio-mode">Check Audio Mode</h3>

<p>The audio mode controls where the audio from the modem is sent. The audio mode has three states as defined on page 192:</p>

<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>audio configured for handset</td>
</tr>

<tr>
<td>1</td>
<td>audio configured for headset</td>
</tr>

<tr>
<td>2</td>
<td>audio configured for speaker</td>
</tr>
</tbody>
</table>

<p>It is unlikely for this mode to be set incorrect, but if you find that you are not hearing any sound after <a href="#configure-the-modem-for-audio">configuring the modem for audio</a>, then it is easy enough to call the <code>AT+QAUDMOD</code> read command for confirmation.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/minicom-check-modem-audio-mode.png"/> 
</figure>


<h3 id="check-audio-mute">Check Audio Mute</h3>

<p>If nobody can hear you during a phone call, you can check to see if uplink voice muting is enabled via the <code>AT+CMUT</code> command on page 189 of the AT commands manual.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/minicom-check-modem-voice-uplink-mute-state.png"/> 
</figure>


<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>Mute off</td>
</tr>

<tr>
<td>1</td>
<td>Mute on</td>
</tr>
</tbody>
</table>

<h3 id="enable-full-functionality">Enable Full Functionality</h3>

<p>As was the case with audio configuration, the <code>/usr/bin/pinephone_setup-modem-audio</code> will enable full phone functionality. However, at the time of writing there is a bug in the code such that if your modem was previously configured with the <a href="#configure-the-modem-for-audio">recommended audio routing</a>, then the script will exit before ensuring that full functionality is also configured.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#999;font-style:italic"># Read current config RET=$(echo &#34;AT+QDAI?&#34; | atinout - $DEV -)</span>

<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">echo</span> <span style="color:#40ffff">$RET</span> | grep -q <span style="color:#40ffff">$QDAI_CONFIG</span>
<span style="color:#6ab825;font-weight:bold">then</span>
        <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;Modem audio already configured&#34;</span>
        <span style="color:#24909d">exit</span> <span style="color:#3677a9">0</span>
<span style="color:#6ab825;font-weight:bold">fi</span>

<span style="color:#999;font-style:italic"># ... Setting full functionality happens below, but code exits above</span>
<span style="color:#999;font-style:italic"># if audio routing was already configured.</span></code></pre></div>
<p>To check that the modem&rsquo;s phone functionality is set to full run the <code>AT+CFUN</code> read command (pg 26).</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/minicom-check-modem-phone-functionality-setting.png"/> 
</figure>


<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>Minimum functionality</td>
</tr>

<tr>
<td>1</td>
<td>Full functionality (default)</td>
</tr>

<tr>
<td>4</td>
<td>radio (transmit &amp; receive) disabled</td>
</tr>
</tbody>
</table>

<p>Unfortunately the manual does not clearly specify what <em>minimal functionality</em> means. Here are two known symptoms that might indicate that the modem is not in <em>full functionality</em> mode.</p>

<ol>
<li><code>AT+COPS?</code> returns a 0, meaning that the operator mode and registration are <code>UNKNOWN</code></li>
<li>Checking <em>PIN</em> status with <code>AT+CPIN?</code> returns <code>+CME ERROR: 13</code></li>
</ol>

<p>Run <code>AT+CFUN 1,1,</code> to enable full modem functionality.</p>

<h3 id="enable--u--sim-card-detection">Enable (U)SIM card detection</h3>

<p>Card detection is what allows a modem to detect a SIM card that was inserted after the modem was already powered on. SIM hot-swapping means that the modem supports the removal of one SIM card and the insertion of another SIM card without having to power-cycle the modem in between. Since the PinePhone&rsquo;s SIM socket is obstructed by the battery when powered on, the PinePhone doesn&rsquo;t truly support hot-swapping SIM cards. That being said, the Quectel EC25 modem does support hot-swapping and we can exploit that feature to validate that the modem has detected the SIM. To get the current settings we need to call the <code>AT+QSIMDET</code> read command on page 70.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/minicom-check-modem-card-detection-and-set-high-level.png"/> 
</figure>


<p>The result has the form <code>+QSIMDET: &lt;enable&gt;,&lt;insert level&gt;</code>.</p>

<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>enable</td>
<td>0</td>
<td>disabled</td>
</tr>

<tr>
<td>enable</td>
<td>1</td>
<td>enabled</td>
</tr>

<tr>
<td>insert level</td>
<td>0</td>
<td>low</td>
</tr>

<tr>
<td>insert level</td>
<td>1</td>
<td>high</td>
</tr>
</tbody>
</table>

<p>A modem power-cycle is required before hot-swap detection becomes effective. If the insert level you pick is inconsistent with the hardware design, then detection will not work. I found that SIM hot-swap detection worked when I enabled the high insert level. To check that the modem has detected a SIM, run the <code>AT+QSIMSTAT</code> read command on page 71. You can also enable <em>SIM insert status reporting</em> via the <code>AT+QSIMSTAT</code> write command as seen below.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/minicom-enable-sim-stat-reporting.png"/> 
</figure>


<p>Status reporting also requires a modem power-cycle before it becomes effective. You might wonder why you would want to enable <em>SIM insert status reporting</em> since it is not possible to insert a SIM into a PinePhone while the battery is in place. I have a <a href="https://en.wikipedia.org/wiki/SIM%5Fcard#Nano-SIM">nano-SIM</a> from a Nexus 6P. The PinePhone socket fits a <a href="https://en.wikipedia.org/wiki/SIM%5Fcard#Micro-SIM">micro-SIM</a>, so I had to fashion a nano-SIM to micro-SIM card adapter out of the cardboard packaging that my SD card came in. The nano-SIM is not only narrower and shorter, but also thinner than the micro-SIM. If the SIM contact area does not fully connect with that of the socket, then the modem will not be able to read the SIM. I enabled <em>SIM insert status reporting</em> so that I can detect if at anytime the SIM&rsquo;s contact moves out of place. It might be that SIM status reporting isn&rsquo;t necessary for my use case; I have not experimented enough with the feature yet to know for sure.</p>

<h3 id="power-saving">Power Saving</h3>

<p>The modem supports the ability to enter sleep mode. To find out whether or not sleep mode is enabled you can call the <code>AT+QSCLK</code> read command on page 207.</p>

<figure>
    <img src="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/minicom-enable-sleep-mode.png"/> 
</figure>


<p>Since I am feeling adventurous, I decided to enable sleep mode to see if the battery life improves as a result. If you choose to do the same, take note in case it causes connectivity issues and needs to be disabled, i.e. enable at your own risk.</p>

<h3 id="get-the-sim-s-imsi">Get the SIM&rsquo;s IMSI</h3>

<p>We are going to need the IMSI number when configuring APN settings in the next section. You can do that by running the <code>AT+CIMI</code> execute command (pg 60). Remember not to share your IMSI with anyone.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">AT+CIMI
&lt;REDACTED-IMI&gt;

OK</code></pre></div>
<h3 id="power-cycle-the-modem">Power-cycle the modem</h3>

<p>Power cycling the modem is as simple as restarting the <code>eg25</code> service. It takes a little while, so be patient.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service eg25 restart</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* Caching service dependencies ...                                       [ ok ]
* Disabling EG25 WWAN module ...
* Enabling EG25 WWAN module ...</code></pre></div>
<p>However, if you don&rsquo;t restart the oFono daemon, then the quectelqmi object path will change in the <code>org.ofono</code> dbus service.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo qdbus --system org.ofono | grep -E <span style="color:#ed9d13">&#39;quectelqmi_\d$&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/quectelqmi_1</code></pre></div>
<p>For that reason you should also restart <code>ofonod</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service ofono restart &amp;&amp; sudo qdbus --system org.ofono | grep -E <span style="color:#ed9d13">&#39;quectelqmi_\d&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"> * Stopping oFono ...                                                     [ ok ]
 * AT debugging is enabled by config
 * command_args_foreground = -d -n
 * Starting oFono ...                                                     [ ok ]
/quectelqmi_0</code></pre></div>
<h2 id="gprs-and-lte-configuration">GPRS &amp; LTE configuration</h2>

<p>Before we can send or receive <em>SMS</em> and make phone calls we need to first configure oFono appropriately for our carrier service. Here are some ways that you can look up your APN settings:</p>

<ol>
<li>Check the list of <a href="https://wiki.pine64.org/index.php/PinePhone%5FAPN%5FSettings#List%5Fof%5Ftested%5Fcarriers">tested APN settings by carrier service for the PinePhone</a></li>
<li>Search your carrier service for published APN Settings</li>
<li>Here is a DuckDuckGo search for <a href="https://duckduckgo.com/?q=complete+list+of+APN+settings"><em>complete list of APN settings</em></a></li>
</ol>

<p>My carrier is Koodo and I was able to find the <a href="https://www.koodomobile.com/en/help/setting-data-your-non-koodo-phone">APN settings at koodomobile.com</a>. Hopefully you are able to find your APN settings without difficulty.</p>

<h3 id="determine-your-operator-service-name">Determine your operator service name</h3>

<p>If your SIM is already registered with a carrier service, then you will be able to get the current service name, status and technology from the modem using DBus:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo qdbus --system org.ofono /quectelqmi_0 org.ofono.NetworkRegistration.GetProperties | grep -iE <span style="color:#ed9d13">&#39;(name|status|technology)&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Name: Koodo
Status: registered
Technology: lte</code></pre></div>
<h3 id="determine-what-technology-standards-your-operator-supports">Determine what technology standards your operator supports</h3>

<p>First scan for operators in the area:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo qdbus --system org.ofono /quectelqmi_0 org.ofono.NetworkRegistration.Scan</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Error: org.freedesktop.DBus.Error.NoReply
Did not receive a reply. Possible causes include: the remote application did not send a reply, the message bus security policy blocked the reply, the reply timeout expired, or the network connection was broken.</code></pre></div>
<p>If you see that error, just ignore it. After the scan has completed, calling <code>GetOperators</code> should return a list of operators returned from the scan which are providing service in your area. Locate the structure containing your <a href="#determine-your-operator-service-name">operator&rsquo;s service name</a> and then look at the <em>Name, Status and Technologies</em> fields. The technologies field should contain the complete list of standards that the operator supports.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo env <span style="color:#40ffff">DISPLAY</span>=<span style="color:#3677a9">0</span>.0 dbus-send --system --print-reply --dest=org.ofono /quectelqmi_0 org.ofono.NetworkRegistration.GetOperators</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">method return time=1590502077.356864 sender=:1.72 -&gt; destination=:1.92 serial=255 reply_serial=2
   array [
      struct {
         object path &#34;/quectelqmi_0/operator/&lt;REDACTED&gt;&#34;
         array [
            dict entry(
               string &#34;Name&#34;
               variant                   string &#34;Koodo&#34;
            )
            dict entry(
               string &#34;Status&#34;
               variant                   string &#34;current&#34;
            )
            dict entry(
               string &#34;MobileCountryCode&#34;
               variant                   string &#34;&lt;REDACTED&gt;&#34;
            )
            dict entry(
               string &#34;MobileNetworkCode&#34;
               variant                   string &#34;&lt;REDACTED&gt;&#34;
            )
            dict entry(
               string &#34;Technologies&#34;
               variant                   array [
                     string &#34;umts&#34;
                     string &#34;lte&#34;
                  ]
            )
         ]
      }</code></pre></div>
<h3 id="shutdown-ofono-service">Shutdown Ofono service</h3>

<p>Since we are going to be manually configuring the APN settings, we must shutdown the oFono daemon, otherwise our changes will not persist.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service ofono stop</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[sudo] password for dustfinger:
 * Stopping oFono ...                                                     [ ok ]
 * Disabling EG25 WWAN module ...</code></pre></div>
<p>For those that are curious: Quectel teamed up with Qualcomm a couple of years ago <a href="https://www.quectel.com/infocenter/news/323.htm">to accelerate the production of <em>Cellular Vehicle-to-Everthing (C-V2X) technology</em></a>. Now, in 2020, we have <a href="https://projects.osmocom.org/projects/quectel-modems/wiki/QMI">Qualcomm Linux Modems by Quectel that use the Qualcomm MSM Interface (QMI)</a>. So, if you know that you have a modem that uses QMI, then you can exploit this knowledge to verify which network interface is exposed by the modem.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo find -L /sys/class/net/ -maxdepth <span style="color:#3677a9">2</span> -type d -name <span style="color:#ed9d13">&#39;qmi&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/sys/class/net/wwan0/qmi</code></pre></div>
<p>The resulting path has the following form: <code>/sys/class/net/&lt;network interface&gt;/qmi</code>.</p>

<h3 id="configure-apn-settings--mvno">Configure APN settings (MVNO)</h3>

<p>I am going to configure my modem for <code>LTE/GPRS</code> coverage. The oFono framework keeps settings in files called stores which are kept in <code>/var/lib/ofono/&lt;IMSI&gt;/{gprs,lte,netreg,radiosetting,sms,voicecall}</code>. These settings files are essentially <em>INI</em> files, so you will be setting key value pairs. You can find out what each key value pair is for by reading the appropriate <a href="https://git.kernel.org/pub/scm/network/ofono/ofono.git/tree/doc">doc files in the repository</a>.</p>

<dl>
<dt><a href="https://git.kernel.org/pub/scm/network/ofono/ofono.git/tree/doc/connman-api.txt">connman-api.txt</a></dt>
<dd>contains properties relevant to APN</dd>
<dt><a href="https://git.kernel.org/pub/scm/network/ofono/ofono.git/tree/doc/lte-api.txt">lte-api.txt</a></dt>
<dd>contains properties relevant to lte</dd>
</dl>

<p>Those documentation files are really about the oFono daemon so they are also valuable reference when making calls over <code>DBus</code>. For our purpose, we only care about the <em>Properties</em> section. Here is what my <code>gprs</code> file contained before editing.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo cat /var/lib/ofono/<span style="color:#6ab825;font-weight:bold">$(</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;AT+CIMI&#34;</span> | atinout - /dev/EG25.AT - | grep -iE <span style="color:#ed9d13">&#39;[0-9]&#39;</span><span style="color:#6ab825;font-weight:bold">)</span>/gprs</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[sudo] password for dustfinger:
[Settings]
Powered=true
RoamingAllowed=false

[context1]
Name=Internet
AccessPointName=
Username=
Password=
AuthenticationMethod=chap
Type=internet
Protocol=ip</code></pre></div>
<p>First, we will edit the <em>lte</em> settings. The configurable properties for <em>lte</em> are straight forward. The most interesting property is the <code>DefaultAccessPointName</code> which defines the <em>APN</em> that will be selected for the next automatic activation. If you set the <code>DefaultAccessPointName</code> to empty string, then it will clear the default APN from the modem&rsquo;s memory.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo vi /var/lib/ofono/<span style="color:#6ab825;font-weight:bold">$(</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;AT+CIMI&#34;</span> | atinout - /dev/EG25.AT - | grep -iE <span style="color:#ed9d13">&#39;[0-9]&#39;</span><span style="color:#6ab825;font-weight:bold">)</span>/lte</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[Settings]
DefaultAccessPointName=sp.koodo.com
Protocol=dual
AuthenticationMethod=None
Username=
Password=</code></pre></div>
<p>There will not be a one-to-one relationship between the APN settings that you find online for your carrier and what you need to configure for oFono, but it should be fairly straight forward to translate. For example, since the <a href="https://www.koodomobile.com/en/help/setting-data-your-non-koodo-phone">Koodo APN settings page</a> shows <em>Blank</em> for <code>Username</code> and <code>Password</code> it made sense to set <code>AuthenticationMethod</code> to <code>None</code> and leave both <code>Username</code> and <code>Password</code> values empty. How did I know to set <code>AuthenticationMethod</code> to <code>None</code> rather than leaving it blank like I did with <code>Username</code> and <code>Password</code>? Look at the properties section in the <a href="https://git.kernel.org/pub/scm/network/ofono/ofono.git/tree/doc/lte-api.txt">lte-api.txt</a> and locate the documentation for the <code>AuthenticationMethod</code> property, there you will find a list of valid values. Similarly, the Koodo APN page shows the field <code>IP Type</code> set to <code>IPv4v6</code>, so I set the <code>Protocol</code> property to <code>dual</code>; again, referring to <a href="https://git.kernel.org/pub/scm/network/ofono/ofono.git/tree/doc/lte-api.txt">lte-api.txt</a>.</p>

<p>Configuring the <code>gprs</code> is more involved. Keep in mind that <em>Koodo</em> is a <em>Mobile Virtual Network Operator</em> (MVNO), that means another operator provides the network infrastructure which Koodo makes use of. Between the two operators I was actually able to figure out a couple of different configurations that all worked fine. The only apparent difference was the DNS settings after connecting to the network.</p>

<p>Using the <a href="https://www.koodomobile.com/en/help/setting-data-your-non-koodo-phone">APN settings at koodomobile.com</a> as a guide, I translated each field into an appropriate property understood by <code>ofonod</code> by looking them up in the <em>Connection Context hierarchy - Properties</em> section of <a href="https://git.kernel.org/pub/scm/network/ofono/ofono.git/tree/doc/connman-api.txt">connman-api.txt</a>. I then updated the <code>gprs</code> section named <em>context1</em> as shown below.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo vi /var/lib/ofono/<span style="color:#6ab825;font-weight:bold">$(</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;AT+CIMI&#34;</span> | atinout - /dev/EG25.AT - | grep -iE <span style="color:#ed9d13">&#39;[0-9]&#39;</span><span style="color:#6ab825;font-weight:bold">)</span>/gprs</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[Settings]
Powered=true
RoamingAllowed=false

[context1]
Name=Koodo
AccessPointName=sp.koodo.com
Username=
Password=
AuthenticationMethod=none
Type=mms
Protocol=dual
MessageCenter=http://aliasredirect.net/proxy/koodo/mmsc
MessageProxy=74.49.0.18:80</code></pre></div>
<p>I should mention that if you enter an invalid configuration, the system might revert your settings in <code>/var/lib/ofono/&lt;IMSI&gt;/{gprs,lte}</code> back to their defaults as soon as the oFono service has been started. In that case, you will need to shutdown the oFono service, edit the configuration and bring the service back online until the configuration is accepted. With that said, it is time to start the oFono service.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nil" data-lang="nil">second-chance:~$ sudo rc-service ofono start</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* AT debugging is enabled by config
* command_args_foreground = -d -n
* Starting oFono ...                                                     [ ok ]</code></pre></div>
<p>and check DBus to see if the context was picked up by the modem.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo qdbus --system org.ofono | grep -i context</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/quectelqmi_0/context1
/quectelqmi_0/context2</code></pre></div>
<p>You might be surprised to see that the modem has two contexts in memory considering that I only configured a single context. Let&rsquo;s shutdown the oFono service and take another look at the <code>gprs</code> configuration.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service ofono stop &amp;&amp; sudo vi /var/lib/ofono/<span style="color:#6ab825;font-weight:bold">$(</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;AT+CIMI&#34;</span> | atinout - /dev/EG25.AT - | grep -iE <span style="color:#ed9d13">&#39;[0-9]&#39;</span><span style="color:#6ab825;font-weight:bold">)</span>/gprs</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[Settings]
Powered=true
RoamingAllowed=false

[context1]
Name=Koodo
AccessPointName=sp.koodo.com
Username=
Password=
AuthenticationMethod=none
Type=mms
MessageCenter=http://aliasredirect.net/proxy/koodo/mmsc
MessageProxy=74.49.0.18:80

[context2]
Name=attach.telus.com
AccessPointName=
Username=
Password=
AuthenticationMethod=chap
Type=internet
Protocol=ip</code></pre></div>
<p>It turns out that <em>context2</em> has no value set for <code>AccessPointName</code>, but it does have an interesting <code>Name</code> property. After quite a bit of experimenting I decided to try assigning the <code>AccessPointName</code> property the same value as the <code>Name</code> property. I then assigned a meaningful name to the <code>Name</code> property and set the other fields exactly the same as <em>context1</em>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[context2]
Name=Telus
AccessPointName=attach.telus.com
Username=
Password=
AuthenticationMethod=none
Type=mms
MessageCenter=http://aliasredirect.net/proxy/koodo/mmsc
MessageProxy=74.49.0.18:80</code></pre></div>
<p>Telus is the name of the <em>Mobile Network Operator</em> (MNO) that <em>Koodo</em> uses for its network infrastructure.</p>

<p>With that change in place, let&rsquo;s start the oFono daemon and double checked that both contexts are recognized by oFono.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service ofono start <span style="color:#3677a9">1</span>&gt; /dev/null &amp;&amp; sudo qdbus --system org.ofono | grep -i context</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">/quectelqmi_0/context1
/quectelqmi_0/context2</code></pre></div>
<p>Both contexts were recognized, but it never hurts to double check the settings after a significant change.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono /quectelqmi_0/context1 org.ofono.ConnectionContext.GetProperties &amp;&amp; qdbus --system org.ofono /quectelqmi_0/context2 org.ofono.ConnectionContext.GetProperties</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">AccessPointName: sp.koodo.com
Active: false
AuthenticationMethod: none
IPv6.Settings: MessageCenter: http://aliasredirect.net/proxy/koodo/mmsc
MessageProxy: 74.49.0.18:80
Name: Koodo
Password:
Protocol: ip
Settings: Type: mms
Username:
AccessPointName: attach.telus.com
Active: false
AuthenticationMethod: none
IPv6.Settings: MessageCenter: http://aliasredirect.net/proxy/koodo/mmsc
MessageProxy: 74.49.0.18:80
Name: Telus
Password:
Protocol: ip
Settings: Type: mms
Username:</code></pre></div>
<p>If the settings were rejected by oFono, then they will be reverted. In that case, you will need to stop the oFono daemon and try tweaking your configuration settings before moving on. You might have noticed that neither context is active. I will be talking about what to do if your context does not become active in the next section.</p>

<h3 id="ensure-a-context-is-active">Ensure a context is Active</h3>

<p>A context should be activated automatically. To see if <code>context1</code> is activate, filter the results of <code>org.ofono.ConnectionContext.GetProperties</code> using grep.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono /quectelqmi_0/context1 org.ofono.ConnectionContext.GetProperties | grep Active</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Active: false</code></pre></div>
<p>Context activation might take several seconds after the oFono daemon has started, so if you check for an active context immediately after oFono starts you might not find one. In that case, wait a few seconds and try again.</p>

<p>If you have ever called <code>ofonoctl wan</code> only to find an empty record set, that is because it was unable to find <em>IPv4</em> or <em>IPv6</em> settings which is a symptom of not having an active context.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo ofonoctl wan</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Interface    Protocol    APN               Method    Address         Gateway      DNS
-----------  ----------  ----------------  --------  --------------  -----------  ----------------------------</code></pre></div>
<p>The reason why the context was not able to activate is because the connection manager is not attached.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono /quectelqmi_0 org.ofono.ConnectionManager.GetProperties | grep Attached</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Attached: false</code></pre></div>
<p>The obvious question to ask now is, how do we get the connection manager to return <code>true</code> for the <code>Attached</code> property? The easiest thing to do is restart the <code>eg25</code> service.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo rc-service eg25 restart &amp;&amp; sudo rc-service ofono restart</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* Disabling EG25 WWAN module ...
* Enabling EG25 WWAN module ...
* Stopping oFono ...                                         [ ok ]
* AT debugging is enabled by config
* command_args_foreground = -d -n
* Starting oFono ...                                         [ ok ]</code></pre></div>
<p>&hellip; and like magic, everything is happy once again.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono /quectelqmi_0 org.ofono.ConnectionManager.GetProperties | grep Attached &amp;&amp; qdbus --system org.ofono /quectelqmi_0/context1 org.ofono.ConnectionContext.GetProperties | grep Active &amp;&amp; ofonoctl wan</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Attached: true
Active: true
Interface    Protocol    APN               Method    Address         Gateway      DNS
-----------  ----------  ----------------  --------  --------------  -----------  ----------------------------
wwan0        ipv4        sp.koodo.com      static    &lt;REDACTED&gt;      &lt;REDACTED&gt;   &lt;REDACTED&gt;, &lt;REDACTED&gt;</code></pre></div>
<p>You are probably wondering how we got into this state in the first place. Unfortunately, I am not sure. I have seen it happen quite a few times now though. If you know the reason, please comment.</p>

<h3 id="static-ip-allocation">Static IP allocation</h3>

<p>There are two prerequisite that must be met before adding a route</p>

<ol>
<li>you must <a href="#ensure-a-context-is-active">ensure that a context is active</a></li>
<li>the method of configuring the host must be <em>static</em></li>
</ol>

<p>To determine if IP allocation is static, simply ask the connection manager.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono /quectelqmi_0/context1 org.ofono.ConnectionContext.GetProperties | grep -E <span style="color:#ed9d13">&#39;^Method&#39;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Method: static</code></pre></div>
<p>If the <code>Method</code> is <code>dhcp</code>, then you will need to use <a href="http://pkgs.postmarketos.org/package/master/postmarketos/armv7/dhcpcd">a dhcp client</a>, such as <a href="https://wiki.alpinelinux.org/wiki/Udhcpc">udhcpc</a> (already installed), for dynamic IP allocation. Technically, you can still add the route while following along, even if the method is dynamic, but realize that your IP could expire during use. I won&rsquo;t be covering <code>dhcp</code> in this post since that is not my use case, but in a future post I hope to show how to configure <em>Network Manager</em> with <em>oFono</em> which will handle dynamic IP allocation for you.</p>

<p>At this point we have established that manual IP allocation is necessary. Now, we must obtain our assigned <em>IP Address</em> and <em>Gateway</em> from the connection context. I think it will be a bit easier to take a look at all of the connection properties at once, rather than filtering fields using grep.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ qdbus --system org.ofono /quectelqmi_0/context1 org.ofono.ConnectionContext.GetProperties</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">AccessPointName: sp.koodo.com
Active: true
AuthenticationMethod: none
IPv6.Settings: MessageCenter: http://aliasredirect.net/proxy/koodo/mmsc
MessageProxy: 74.49.0.18:80
Name: Koodo
Password:
Protocol: ip
Settings: Address: &lt;REDACTED&gt;
DomainNameServers: &lt;REDACTED&gt;
&lt;REDACTED&gt;
Gateway: &lt;REDACTED&gt;
Interface: wwan0
Method: static
Netmask: 255.255.255.0
Type: mms
Username:</code></pre></div>
<p>The first thing I want to mention is that <code>qdbus</code> doesn&rsquo;t format this output perfectly. Whenever a property is a dictionary, <code>qdbus</code> prints the next property on the same line. For example, <code>Message Center</code> and <code>Address</code> should both be on their own lines. I will reformat the output for clarity.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">AccessPointName: sp.koodo.com
Active: true
AuthenticationMethod: none
IPv6.Settings:
MessageCenter: http://aliasredirect.net/proxy/koodo/mmsc
MessageProxy: 74.49.0.18:80
Name: Koodo
Password:
Protocol: ip
Settings:
  Address: &lt;REDACTED-ADDRESS&gt;
  DomainNameServers: &lt;REDACTED-DNS-1&gt;
  &lt;REDACTED-DNS-2&gt;
  Gateway: &lt;REDACTED-GATEWAY&gt;
  Interface: wwan0
  Method: static
  Netmask: 255.255.255.0
Type: mms
Username:</code></pre></div>
<p>The second thing to notice is that the <code>Protocol</code> property is set to <code>ip</code>. That means that the carrier service has assigned me an IPv4 address. All of the IPv4 settings are found in the <code>Settings</code> property. If the protocol had been <code>ipv6</code> instead, then the <code>IPv6.Settings</code> property would have been populated.</p>

<p>Let&rsquo;s make sure we are in a consistent starting state by purging all allocated addresses from the interface using the <code>flush</code> sub command. Please be aware that the <code>flush</code> sub command will ruthlessly remove all routes linked to the device&rsquo;s interface. As you become comfortable with manipulating routes you will find that you can modify or remove an invalid route. So you can see that flushing is usually not necessary, but it will ensure we are in an consistent state moving forward.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo ip addr flush dev wwan0</code></pre></div>
<p>The routing table should not show any routes for interface <code>wwan0</code>, but you will see routes for <code>wlan0</code> if you have <em>Wi-Fi</em> up.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ip route show</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">172.16.0.0/16 dev usb0 scope link  src 172.16.42.1</code></pre></div>
<p>As you can see, there exists a link scope route for <code>usb0</code>. Notice that the IP address is followed by a forward slash and then a decimal number. The decimal number actually represents the prefix length which is the count of leading one bits in the routing mask, traditionally called the network mask. We can use, the <code>ipcalc</code> command to calculate the prefix length of any IP address given a routing mask.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ipcalc -p &lt;REDACTED-ADDRESS&gt; <span style="color:#3677a9">255</span>.255.255.0</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">PREFIX=24</code></pre></div>
<p>The arrangement of <code>IP/PREFIX</code> is known as <a href="https://en.wikipedia.org/wiki/Classless%5FInter-Domain%5FRouting#CIDR%5Fnotation">Classless Inter-Domain Routing</a> (CIDR) notation and is equivalent to the more traditional representation of <code>IP/Netmask</code>. We can use the <code>ip</code> (see <a href="https://man7.org/linux/man-pages/man8/ip.8.html">ip(8)</a>) command to add the address provided by oFono to our interface using either CIDR or traditional notation (thank you sicelo). However; we can avoid unnecessarily calculating the prefix length by sticking with tradition using the netmask already provided to us by oFono.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">second-chance:~$ sudo ip addr add &lt;REDACTED-ADDRESS&gt;/255.255.255.0 dev wwan0</code></pre></div>
<p>Let&rsquo;s see if that had any effect on our routing table.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ip route show</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&lt;REDACTED-SUBNET&gt;/24 dev wwan0 scope link  src &lt;REDACTED-ADDRESS&gt;
172.16.0.0/16 dev usb0 scope link  src 172.16.42.1</code></pre></div>
<p>Our newly added link scope route for <code>wwan0</code> represented in CIDR notation is now in the routing table. Before our network interface can be used to access the internet, we must first add an route to the gateway defined in our active context for the <code>wwan0</code> interface. Let&rsquo;s add a default route (for all addresses) via the gateway <code>&lt;REDACTED-GATEWAY&gt;</code> now.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo ip route add default via &lt;REDACTED-GATEWAY&gt; dev wwan0</code></pre></div>
<p>Another look at our routing table will show the newly added route.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ip route show</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">default via &lt;REDACTED-GATEWAY&gt; dev wwan0
&lt;REDACTED-SUBNET&gt;/24 dev wwan0 scope link  src &lt;REDACTED-ADDRESS&gt;
172.16.0.0/16 dev usb0 scope link  src 172.16.42.1</code></pre></div>
<p>The connection context tells us which DNS addressess our carrier service would like us to use when resolving domain names. If you are wondering whether or not you should trust your carrier service&rsquo;s DNS or a third party, such as <a href="https://servers.opennic.org/">OpenNic</a>, <a href="https://www.opendns.com/">OpenDNS</a> , <a href="https://www.dnscrypt.org/">DNSCrypt</a> etc., then I recommend reading <a href="https://www.grepular.com/DNSCrypt%5FReduces%5FPrivacy">DNSCrypt Reduces Privacy</a>. I am not suggesting that defending ones privacy is hopeless, but it is a topic deserving of its own series of blog posts. For the purposes of this article, I will be adding my carrier service&rsquo;s DNS to resolv.conf.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nameserver &lt;REDACTED-DNS-1&gt;&#34;</span> | sudo tee -a /etc/resolv.conf
<span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nameserver &lt;REDACTED-DNS-2&gt;&#34;</span> | sudo tee -a /etc/resolv.conf</code></pre></div>
<p>Now we should be able to ping a domain on the Internet:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ping bloggerbust.ca</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">PING bloggerbust.ca (185.199.111.153): 56 data bytes
64 bytes from 185.199.111.153: seq=0 ttl=42 time=27.402 ms
64 bytes from 185.199.111.153: seq=1 ttl=42 time=28.191 ms
64 bytes from 185.199.111.153: seq=2 ttl=42 time=27.031 ms

--- bloggerbust.ca ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 27.031/27.541/28.191 ms</code></pre></div>
<p>You have probably heard of <a href="https://git.sr.ht/~martijnbraam/ofonoctl/">ofonoctl</a> by Martin Braam. When you run <code>ofonoctl wan</code>, it locates your active context and tabulates the IP Address, Gateway and DNS just as we did above. When you add the <code>--connect</code> optional parameter, <code>ofonoctl</code> flushes your <code>wwan0</code> interface (only if the allocation method is static) and adds the IP Address and DNS that it found in the active context. When you add the <code>--append-dns</code> optional parameter, then it will append the DNS to your <code>/etc/resolv.conf</code> for you. So why the heck did I just make you do it all manually? Now you know how it works. Now you will have an idea what might be wrong the next time you run:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ofonoctl wan --connect --append-dns</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Interface    Protocol    APN               Method    Address         Gateway      DNS
-----------  ----------  ----------------  --------  --------------  -----------  ----------------------------</code></pre></div>
<p>&hellip; and an empty record-set is displayed.</p>

<p>There is still an issue that you will be dealing with. Every time you bring up or down the <code>Wi-Fi</code> connection, Network Manager will completely override <code>/etc/resolv.conf</code>. In a future post I will write about how to deal with this issue. For now, just be aware that this is happening and know that you will have to re-append the DNS each time. You might want to write yourself a script to do that for you.</p>

<h2 id="send-and-receive-sms">Send and receive SMS</h2>

<p><strong>UPDATE:</strong> <em>Spacebar</em> is now working. Message history is not persistentn yet. Phone numbers in <em>Spacebar</em> are not yet resolved to contact names added to the <em>Phone Book</em> app. I have found that the first time I start space bar it often crashes and I have to start it again.</p>

<p>Plasma Mobile has an SMS app named <em>Spacebar</em>, but at the time of writing I was not able to get <em>Spacebar</em> working. Instead, we are going to test both sending and receiving SMS from the command line. To receive SMS we will run a <code>dbus-monitor</code> process in the background that will read all messages on the <code>org.ofono.MessageManager</code> interface and print it to <code>STDOUT</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ sudo env <span style="color:#40ffff">DISPLAY</span>=:0.0 dbus-monitor --system <span style="color:#ed9d13">&#34;type=&#39;signal&#39;,interface=&#39;org.ofono.MessageManager&#39;,member=&#39;IncomingMessage&#39;&#34;</span>&amp;</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">signal time=1589836625.655331 sender=org.freedesktop.DBus -&gt; destination=:1.151 serial=2 path=/org/freedesktop/DBus; interface=org.freedesktop.DBus; member=NameAcquired
   string &#34;:1.151&#34;
signal time=1589836625.655487 sender=org.freedesktop.DBus -&gt; destination=:1.151 serial=4 path=/org/freedesktop/DBus; interface=org.freedesktop.DBus; member=NameLost
   string &#34;:1.151&#34;</code></pre></div>
<p>To send a message use the <code>ofonoctl sms</code> command.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">second-chance:~$ ofonoctl sms &lt;PHONE-NUMBER-NO-SPACES&gt; --message <span style="color:#ed9d13">&#34;Let me know if you receive this message. I am sending it from postmarketOS/PlasmaMobile.&#34;</span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Sent</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">second-chance:~$ signal time=1589837304.873843 sender=:1.73 -&gt; destination=(null destination) serial=321 path=/quectelqmi_0; interface=org.ofono.MessageManager; member=IncomingMessage string &#34;Message received! We are at a little garden centre near stony plain.&#34;
 array [
    dict entry(
       string &#34;LocalSentTime&#34;
       variant             string &#34;2020-05-18T15:28:19-0600&#34;
    )
    dict entry(
       string &#34;SentTime&#34;
       variant             string &#34;2020-05-18T17:28:19-0400&#34;
    )
    dict entry(
       string &#34;Sender&#34;
       variant             string &#34;&lt;PHONE-NUMBER-REDACTED&gt;&#34;
    )
 ]</code></pre></div>
<h2 id="make-phone-calls">Make phone calls</h2>

<p>Plasma Mobile has a phone app that works fine for both sending and receiving phone calls. I do not hear any sound when dialing, but I do hear the phone ringing while I wait for someone to answer. When someone does answer, they can hear me clearly, but I have been told that I sound a bit &ldquo;tinny&rdquo;. If the receiving phone is within a couple of meters of the PinePhone, then the audio of the PinePhone becomes noisy with interference.</p>

<p><strong>UPDATE:</strong> for a while I was unable to hear or be heard during phone calls. An update this weekend fixed whatever was wrong. I can now both make and receive phone calls. I have found that sometimes I need to restart the <code>eg25</code> and <code>ofono</code> services once before phone calls work properly: <code>sudo rc-service eg25 restart &amp;&amp; sudo rc-service ofono restart</code>, then wait about 10 seconds or so before making a phone call. There are new updates nearly every day, so your experience might be different.</p>

<h2 id="conclusion">Conclusion</h2>

<p>At this point you should be able to send and receive SMS and make phone calls. This was a long post and there was a lot that I didn&rsquo;t cover. I have updated this post several times and I am now ready to move on. You can watch for new related posts under the <a href="https://bloggerbust.ca/categories/mobile/">mobile category</a>, or use the tags: <a href="https://bloggerbust.ca/tags/pinephone/">Pine Phone</a>, <a href="https://bloggerbust.ca/tags/postmarketos/">PostmarketOS</a>, <a href="https://bloggerbust.ca/tags/plasma%5Fmobile">Plasma Mobile</a>/. The PostmarketOS PinePhone wiki has instructions for <a href="https://wiki.postmarketos.org/wiki/PINE64%5FPinePhone%5F(pine64-pinephone)#Components">setting up and experimenting with components</a> not covered here. Enjoy!</p>

<p>In my next post, I am going to write about my first attempt at configuring Network Manager with oFono as the modem manager.</p>
 </div>
    <footer class="post-footer">

  <div class="post-footer-data">
    
<div class="tags">
    
      <div class="tag">
        <a href="https://bloggerbust.ca/tags/pinephone">#pinephone</a>
      </div>
    
      <div class="tag">
        <a href="https://bloggerbust.ca/tags/postmarketos">#postmarketOS</a>
      </div>
    
      <div class="tag">
        <a href="https://bloggerbust.ca/tags/plasma_mobile">#plasma_mobile</a>
      </div>
    
</div>

    <div class="date"> Jun 7, 2020 </div>
  </div>

</footer>



  
<hr>
<h2 id="Comments">
  Comments
</h2>
    <form class="comment" method="POST" action="https://staticman.bloggerbust-bot.now.sh/v2/entry/BloggerBust/bloggerbust.ca/master/comments" class="flex-container flex-column">
  <input type="hidden" name="options[redirect]" value="https://bloggerbust.ca/post/install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone/#comment-submitted">
  <input type="hidden" name="options[slug]" value="install_and_configure_postmarketos_with_plasma_mobile_on_the_pinephone">
  <div class="flex-container flex-row">
    <input name="fields[name]" type="text" placeholder="Your name" class="flex-item">
    <input name="fields[email]" type="email" placeholder="Your email address" class="flex-item">
  </div>
  <div class="flex-container flex-row">
    <textarea name="fields[message]" placeholder="Your message. Feel free to use Markdown." rows="10" class="flex-item"></textarea>
  </div>
  <div class="flex-container flex-row">
    <input type="submit" value="Submit" class="flex-item">
  </div>
</form>
<div id="comment-submitted">
  Your comment has been submitted and is now pending moderation
</div>

    




  

  

  
    
    
<blockquote class="comment">
  <p>Thank you for the great in depth article.  This was and will be very helpful.</p>
  <cite class="flex-container flex-row flex-end">
    <img class="flex-item avatar" src="https://www.gravatar.com/avatar/51528b1accd3f9a0fa42a6bc0ca894ef?s=50&d=retro">
    <div class="flex-container flex-column flex-item flex-center">
      <strong>David Slaughter</strong><br>18/06/2020
    </div>
  </cite>
</blockquote>
    
<blockquote class="comment">
  <p><p>Thank you Darcy &amp; Lukasz!</p>

<p>I enjoyed writing this article and I plan on improving it with more updates. It is not meant as a terse step by step guide for an audience that wants to get their phone up and running as quickly as possible. PostmarketOS + Plasma Mobile isn&rsquo;t ready for that sort of use-case anyway. Instead, it is an account of my own learning and exploration, written in a slight conversational tone, and is intended for those that would like to better understand how things work.</p>

<p>If either of you have any suggestions for improvements please let me know. I have already received valuable feedback from #postmarketOS (irc.freenode.net) and #pinephone (irc.pine64.org) channels. Thank you everyone for your tips and suggestions.</p>
</p>
  <cite class="flex-container flex-row flex-end">
    <img class="flex-item avatar" src="https://www.gravatar.com/avatar/79ad80bd825ee2d3d91b885caa22bf1f?s=50&d=retro">
    <div class="flex-container flex-column flex-item flex-center">
      <strong>Trevor Wilson</strong><br>17/06/2020
    </div>
  </cite>
</blockquote>
    
<blockquote class="comment">
  <p>What an incredibly comprehensive write-up. I appreciate all of the security- and privacy-mindfulness throughout your post, especially involving LUKS (which is a pre-requisite for true mobile security). Thank you for your work on this!</p>
  <cite class="flex-container flex-row flex-end">
    <img class="flex-item avatar" src="https://www.gravatar.com/avatar/ef9272018a6fa6cc15853749bc6786e2?s=50&d=retro">
    <div class="flex-container flex-column flex-item flex-center">
      <strong>Darcy Sabatino</strong><br>17/06/2020
    </div>
  </cite>
</blockquote>
    
<blockquote class="comment">
  <p>Amazing write-up, great job!</p>
  <cite class="flex-container flex-row flex-end">
    <img class="flex-item avatar" src="https://www.gravatar.com/avatar/06032ed9be50f93a0a1f2dd3f331d2c3?s=50&d=retro">
    <div class="flex-container flex-column flex-item flex-center">
      <strong>Lukasz Erecinski</strong><br>17/06/2020
    </div>
  </cite>
</blockquote>
    
<blockquote class="comment">
  <p><p>Your Welcome Sundar!</p>

<p>I added more detail to GPRS &amp; LTE configuration. I also added a new section on taking screen shots over serial / SSH in a Qt environment. I will probably update this a couple of more times before moving on to something new.</p>
</p>
  <cite class="flex-container flex-row flex-end">
    <img class="flex-item avatar" src="https://www.gravatar.com/avatar/79ad80bd825ee2d3d91b885caa22bf1f?s=50&d=retro">
    <div class="flex-container flex-column flex-item flex-center">
      <strong>Trevor Wilson</strong><br>17/06/2020
    </div>
  </cite>
</blockquote>
    
<blockquote class="comment">
  <p>This is the best write-up I have seen in configuring postmarketOS with Plasma on PinePhone! Thank you very much. Awesomeoness!</p>
  <cite class="flex-container flex-row flex-end">
    <img class="flex-item avatar" src="https://www.gravatar.com/avatar/5e84fdab86675df1ea3fd00b02df694a?s=50&d=retro">
    <div class="flex-container flex-column flex-item flex-center">
      <strong>Sundar</strong><br>15/06/2020
    </div>
  </cite>
</blockquote>
    
  

  

  

  

  




  


</article>

  <footer>

  <div class="social-links-footer">

  
  <a href="mailto:trevor.wilson@bloggerbust.ca"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/bloggerbust" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  

  

  <div class="social-link">
  <a href="https://bloggerbust.ca/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright"> Copyright (c) 2018, all rights reserved. </div>

  <div class="poweredby">
    Powered by <a href="https://gohugo.io/">Hugo</a>.
  </div>

  </footer>

</div> 

</body>
</html>

